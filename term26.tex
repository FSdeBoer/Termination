\documentclass[runningheads]{llncs}       % Frank's version only !

%\documentclass[runningheads]{./llncs/llncs} % version in the git

\usepackage{enumerate}

\usepackage{graphicx,color}

\input NEW-commands.tex

\author{
Krzysztof R. Apt \inst{1} \and
Frank S. de Boer \inst{2} \and
Ernst-R\"udiger Olderog \inst{3}
}

\authorrunning{K.R. Apt, F.S. de Boer and E.-R. Olderog} 
% First names are abbreviated in the running head.
% If there are more than two authors, 'et al.' is used.

\institute{
CWI, Amsterdam, The Netherlands\\
MIMUW, University of Warsaw, Poland\\
\email{apt@cwi.nl} 
\and
CWI, Amsterdam, The Netherlands\\
\email{F.S.de.Boer@cwi.nl}
\and
Carl von Ossietzky University of Oldenburg, Oldenburg, Germany\\
\email{olderog@informatik.uni-oldenburg.de}
}


\title{Proof Rules for Termination of Loops:\\
       A Comprehensive Analysis}

\titlerunning{Termination of Loops}

\begin{document}

\maketitle

\begin{abstract}
CHANGED (`COMPREHENSIVE' INSTEAD OF 'FOUR')

\NI
  We provide a comprehensive analysis of different proof rules for proving termination of
  \textbf{while} programs and show their proof-theoretic equivalence.
  This involves a proof-theoretic analysis of various auxiliary proof
  rules in Hoare's logic.  By discussing representations of proofs in
  the form of proof outlines, we reveal differences between these
  equivalent proof rules when used in practice.  We also address
  applications in the context of the paradigm of design by contract.
\end{abstract}


\section{Introduction}

In his seminal paper \cite{Hoa69}, Hoare introduced an axiomatic method of reasoning
about correctness of \textbf{while} programs, now called Hoare's logic. 
It is based on correctness formulas
$\HT{p}{S}{q}$, where $S$ is a program and $p$ and $q$ are assertions
(logical formulas), with the interpretation
   \begin{quote}
   ``If the assertion $p$ is true before initiation of a program $S$,
     then the assertion $q$ will be true on its completion.''
   \end{quote}
In this context $p$ is referred to as a \emph{precondition} and $q$ as 
a \emph{postcondition} of $S$.

However, in contrast to Floyd's earlier paper \cite{Flo67a} that dealt
with correctness of flowchart programs, program termination was not
addressed. To stress this difference one distinguishes now between
\emph{partial correctness} that only focuses on the delivery of
correct results, and \emph{total correctness}, that in addition
stipulates that the program terminates.  So the original proposal of
Hoare dealt with partial correctness.

All approaches to proving program termination within Hoare’s logic formalize 
Floyd’s \cite{Flo67a} observation that
    \begin{quote}
    ``Proofs of termination are dealt with by showing that each step of a program 
      decreases some entity which cannot decrease indefinitely.”
    \end{quote}

The first extension of Hoare's logic
to deal with total correctness is due to~\cite{MP74}. 
Since then substantially simpler proof rules were proposed.
In these proof rules variables that range over natural numbers are used.
An appropriate relative completeness result, see for example \cite{ABO09}, 
shows that variables ranging over more general well-founded orderings 
are not needed.

Termination continues to be a relevant and vibrant topic in program
analysis, see for example~\cite{CookPR11} and the Annual International
Termination Competition\footnote{
\texttt{https://termination-portal.org/wiki/Termination\_Competition}}.
The latter comprises various competition categories, 
for instance proving termination of 
C programs, Java bytecode programs, logic programs,
functional programs, and term rewriting systems.
Here we focus on the shape of termination proofs in the context of
Hoare's logic. 
To this end, we investigate four natural proof rules 
from the proof-theoretic point of view.
More specifically, we study {\bf while} programs with Hoare's 
original proof system for program correctness, in which the well-known
proof rule for partial correctness of the {\bf while} loops, which we
call the LOOP I rule, is replaced by a suitable proof rule for
establishing total correctness.  We analyze four versions of such a
proof rule. 



\medskip

\NI


\begin{itemize}

\item 
% The LOOP III rule allows us to document proofs as \emph{proof
%   outlines}, which is in particular useful when arguing about the
%   interference freedom of component proofs in the context of parallel
%   programs.
The LOOP II rule involves a single, monolithic proof which establishes an invariant, termination of the body of the \rm{while} loop,
and which ensures that the body itself cannot be executed infinitely often
by a so-called bound function.
% \item The LOOP IV rule is particularly well-suited when dealing with nested loops
%       because it modularizes the correctness proof of the outer loop from
%       the ones of the inner loops. It is a \emph{hybrid} proof rule with
%       premises referring to proof systems for both partial and total correctness.

\item The LOOP III rule achieves a separation of the reasoning about
  the invariant and the bound function.

\item
The LOOP IV rule not only achieves a separation of the reasoning about
the invariant and the bound function, it additionally involves
a separate proof of the termination the body itself.
As such it is particularly well-suited when dealing with nested loops
because it modularizes the correctness proof of the outer loop from
the ones of the inner loops. It is a \emph{hybrid} proof rule with
premises referring to proof systems for both partial and total correctness.

\item The LOOP V rule, like the LOOP II rule, is a monolithic rule
which formalizes reasoning  about termination of a \rm{while} loop in a single proof.
However, instead  of an explicit representation of the bound function
it uses  a parameter of the invariant itself.

\end{itemize}

Depending on the choice of the loop rule, we obtain proof systems that
we refer to by II, III, IV, and V, respectively.  We show that these
four proof systems are equivalent in the sense that every proof of a
correctness formula $\HT{p}{S}{q}$ carried out in one of these systems
can be effectively transformed into a correctness proof in any other
of these proof systems.  This result is obtained by a detailed
proof-theoretic analysis of the four loop rules in the context of
these proof systems. In this analysis we make use of
auxiliary proof rules which we show to be admissible in the proof systems.

Even though Hoare's logic has been extensively studied (see for
example our survey \cite{AO19}), little work has been done on the
analysis of proofs in Hoare's logic. We are familiar with only three
references, \cite{Apt81a}, \cite{GR16}, and \cite{Tiu02}, in which
transformations of proofs in a Hoare logic are discussed.

While these proof rules are equivalent, their use and representation
in the form of proof outlines, which are programs annotated by
assertions, differs. We illustrate this by analyzing a termination
proof of a program with nested loops. We also address applications in
the context of assertions used as annotations in the design by
contract paradigm.



\section{Preliminaries}

\III
\NI
INCLUDED DERIVABILITY IN THE SUBSECTION TITLE

\subsection{Derivability , admissibility and equivalence}

Assume a given language that is determined by its set of formulas.  In
what follows we assume that all considered axioms, proof rules, and
proof systems are concerned with the same language.

Given a proof system \emph{PR} and two sequences of formulas
$\phi_1, \LL, \phi_m$ and $\varphi_1, \LL, \varphi_n$ we write
\[
  \phi_1, \LL, \phi_m \vdash_{PR} \varphi_1, \LL, \varphi_n
\]
to denote the fact that each formula $\varphi_i$ can be proved in
\emph{PR} using as additional axioms the formulas
$\phi_1, \LL, \phi_m$.  We also use this notation when the sequence
$\phi_1, \LL, \phi_m$ is empty and when \emph{PR} is a set of proof
rules.

\III
\NI
DEFINITION DERIVABILITY ADDED

A proof rule
\[ 
  (R) \qquad \frac{\varphi_1,\LL,\varphi_k}{\varphi}
\]
is called \bfe{derivable} in \emph{PR}  if
\[
 \varphi_1, \LL, \varphi_k \vdash_{\mathit{PR}} \varphi.
\]
\NI
END

% A proof rule
% \[ 
%   (R) \qquad \frac{\varphi_1,\LL,\varphi_k}{\varphi}
% \]
Such a rule 
is called \bfe{admissible in} \emph{PR} (see, e.g.~\cite[page 47]{Pla13}) if
\[
 \vdash_{\mathit{PR}} \varphi_1, \LL, \vdash_{\mathit{PR}} \varphi_k
 \mbox{ implies }
 \vdash_{\mathit{PR}} \varphi.
\]
Intuitively, if a rule is admissible in \emph{PR}
it does not increase the power of the proof system \emph{PR} \cite{Pla13}, 
but it serves as a lemma that simplifies proofs in \emph{PR} by condensing
a detailed proof argument into one application of $(R)$.

\NI
EXPLANATION DERIVABILITY ADDED

The application of a derivable rule can  be replaced locally without
affecting the overall proof structure,  which in general is not the case
with the application of an admissible rule.
A derivable rule is also an admissible rule,  but in general the converse
does not hold.

\NI
END

We say that two proof systems $\it{PR}_1$ and $\it{PR}_2$ are \bfe{equivalent}
if for all formulas $\varphi$
\[
 \mbox{$\vdash_{\mathit{PR}_1} \varphi$ iff $\vdash_{\mathit{PR}_2} \varphi$.}
\]

\III
\NI
SOME BASIC FACTS ADDED.

Note that two proof systems 
are equivalent if and only if any rule of  the one
is admissible in  the other.

Given a semantics,
we denote by $\models \phi$ that the formula $\phi$ is
\bfe{valid}.
A proof rule 
is \bfe{sound} if  validity of its premises implies that of its conclusion.
A proof system \mbox{\it PR} is sound if $\vdash_{\mbox{\it PR}} \varphi$
implies $\models \varphi$.
A system \mbox{\it PR} is \bfe{complete} if 
$\models \varphi$ implies
$\vdash_{\mbox{\it PR}} \varphi$.
Let \mbox{\it PR} be a sound and complete proof system.
It follows that any sound rule is admissible in \mbox{\it PR}.

To prove that the proof systems $\it{PR}_1$ and $\it{PR}_2$
are equivalent it thus suffices to show that
the rules of the one are admissible in the other or that both
systems are sound and complete.The first approach in general requires
tedious and complicated proofs by induction on the length of the derivation of the
premises of the proof rules.
The latter approach involves in general complicated completeness proofs.





\NI
END


\NI 
LEMMA 1 REFORMULATED AS THE GENERAL APPROACH.

% The notions of derivability and equivalence are connected by the following simple observation.

% \begin{lemma} \label{lem:equiv}
% % Consider a proof system \it{PR} and proof rules $R_1$ and $R_2$.

% % The proof systems $\mathit{PR} \cup \{R_1\}$ and
% % $\mathit{PR} \cup \{R_2\}$ are equivalent iff $R_1$ is admissible in
% % $\mathit{PR} \cup \{R_2\}$ and $R_2$ is admissible in
% % $\mathit{PR} \cup \{R_1\}$.
% Consider a proof system \it{PR} and proof rules $R$, $R_1$ and $R_2$.
% \begin{itemize}
% \item If $R$ is derivable  in
% $\mathit{PR} \cup \{R_1\}$ and $R_1$ is derivable in
% $\mathit{PR} \cup \{R_2\}$ then $R$ is derivable  in
% $\mathit{PR} \cup \{R_2\}$.
% \item
% The proof systems $\mathit{PR} \cup \{R_1\}$ and
% $\mathit{PR} \cup \{R_2\}$ are equivalent if $R_1$ is derivable  in
% $\mathit{PR} \cup \{R_2\}$ and $R_2$ is derivable in
% $\mathit{PR} \cup \{R_1\}$.


% \end{itemize}

% \end{lemma}
Instead, the use of \bfe{ auxiliary rules}
allows us to combine
the notions of admissible and derivable rules in a structured way that 
simplifies the proofs of equivalence between the proof systems
which only differ in the  considered LOOP rules.
More
precisely, the following lemma 
summarizes our general approach to proving that two systems
$\mbox{\it PR}\cup\{R\}$
and $\mbox{\it PR}\cup\{R'\}$ are equivalent.

\begin{lemma}\label{lem:equiv}
Given  sets \mbox{\it AUX1} and \mbox{\it AUX2} of \emph{auxiliary} rules,
the proof systems $\mbox{\it PR}\cup\{R\}$
and $\mbox{\it PR}\cup\{R'\}$ are equivalent if the following holds.
\begin{itemize}
\item $A\in \mbox{\it AUX1}$ ($A \in \mbox{\it AUX2} $)
is \emph{admissible} in $\mbox{\it PR}\cup\{R\}$  ($\mbox{\it PR}\cup\{R'\}$).
\item  $R$ ($R'$) is \emph{derivable}
in the system $\mbox{\it PR}\cup \mbox{\it AUX1}\cup\{R'\}$ 
($\mbox{\it PR}\cup \mbox{\it AUX2}\cup\{R\}$).
\end{itemize}
\end{lemma}

\begin{proof}
For any proof system \mbox{\it PR} and set of rules \mbox{\it AUX}
we have that if any $A\in \mbox{\it AUX}$ is admissible in \mbox{\it PR} then \mbox{\it PR} and
$\mbox{\it PR}\cup\mbox{\it AUX}$ are equivalent.
So we derive from the first item  that the systems $\mbox{\it PR}\cup \{R\}$
and $\mbox{\it PR}\cup \{R\} \cup \mbox{\it AUX1}$ are equivalent, and similarly, that $\mbox{\it PR}\cup \{R'\}$
and $\mbox{\it PR}\cup \{R'\} \cup \mbox{\it AUX2}$ are equivalent.




In general, we further have that if  $R$ is derivable in \mbox{\it PR} 
and the proof systems \mbox{\it PR} and $\mbox{\it PR}'$ are equivalent
then  $R$ is \emph{admissible} in $\mbox{\it PR}'$. 


So we derive  that  $R$ is admissible in $\mbox{\it PR}\cup \{R'\}$
and similarly, that $R'$ is admissible in $\mbox{\it PR}\cup \{R\}$.
From this it follows that $\mbox{\it PR}\cup \{R'\}$ and
$\mbox{\it PR}\cup \{R\}$ are equivalent.


\HB
\end{proof}

\NI
END 

\subsection{LOOP rules}

From now on we shall be concerned with the language, the formulas of
which are either first-order formulas, called \bfe{assertions}, or
\bfe{correctness formulas}, which are constructs of the form $\HT{p}{S}{q}$,
where $p$ and $q$ are assertions and $S$ is a \textbf{while} program.

\NI GLOBAL DISTINCTION LOGICAL AND PROGRAM VARIABLES ADDED

We assume in the definition of assertions two disjoint sets of variables: a set \emph{lvar} of \bfe{logical} variables
and a set \emph{pvar} of \bfe{program} variables such that programs
only refer to program variables and logical variables
are used in assertions as \bfe{freeze} variables
or \bfe{quantified} variables.

\NI
END

Below we denote by $\mathit{free}(p)$
the set of free variables of the assertion $p$ and by $var(t)$, $var(B)$, and $var(S)$ 
the set of variables that appear in the
expression $t$, the Boolean expression $B$, and the program $S$, respectively.



We shall consider in total five proof systems concerned with the
correctness formulas. They only differ in the used LOOP rule.

Proof system I denotes the customary proof system allowing us to prove 
partial correctness of {\bf while} programs.  
Its axioms and proof rules, due to \cite{Hoa69}, are listed in Appendix~\ref{sec:I}.

\III
\NI
ADDED NOTATION SUBSTITUTION

Here and below we denote by $p[x:=t]$ the result of replacing  free occurrences of the variable
$x$ in $p$ by $t$ (assuming that after the replacement  no variables of $t$ 
fall in the scope of a quantifier in $p$).

\NI
END

%taken from our book \cite{ABO09}, are listed in the Appendix.
Its LOOP rule has the following form:
\III

\NI
RULE LOOP I
\[ 
 \frac{ \HT{p \A B}{S}{p}                }
      { \HT{p}{\WDD{B}{S}}{p \A \neg B}  }
\]
\III




In the proof system II this rule  is replaced by
\III

\NI
RULE LOOP II
\[
 \begin{array}{l}
  \HT{p \A B \A t=z}{S}{p \A t<z},          \\
  p \ra t \geq 0                           \\
  [-\medskipamount]
  \hrulefill                                \\
  \HT{p}{\WDD{B}{S}}{p \A \neg\ B}
 \end{array}
\]

\III
\NI
THE RESTRICTION ON t IS CHANGED TO
$var(t)\subseteq \mbox{\it pvar}$ AND THE VARIABLE
z IS INTRODUCED AS A LOGICAL VARIABLE WHICH DOES NOT APPEAR
(FREE) IN THE INVARIANT p.

\NI
where $t$ is an integer expression such that  $var(t)\subseteq \mbox{\it pvar}$
and $z$ is a \emph{logical} integer variable that
does not appear (free) in $p$.




\III

In the proof system III  LOOP I rule is replaced by
\III

\NI
RULE \label{rul:loop2} LOOP III
\[
 \begin{array}{l}
  \HT{p \A B}{S}{p},                      \\
  \HT{p \A B \A t=z}{S}{t<z},             \\
  p \ra t \geq 0                         \\
  [-\medskipamount]
  \hrulefill                              \\
  \HT{p}{\WDD{B}{S}}{p \A \neg\ B}
 \end{array}
\]
%
\NI
where $t$ and $z$ are as above.

\III

In the context of the LOOP rules discussed here, 
the assertion $p$ is called the \bfe{loop invariant} and the expression $t$
is called the \bfe{bound function}. It provides an estimate how
many iterations the loop will still perform before termination.

We shall consider next the following hybrid rule that combines provability in two
proof systems.
\III

\NI
RULE LOOP IV
\[
 \begin{array}{l}
  \vdash_{\rm{I}}  \HT{p \A B}{S}{p},             \\
  \vdash_{\rm{I}}   \HT{p \A B \A t=z}{S}{t<z},   \\
  \HT{p \A B}{S}{\mathbf{true}},                  \\
  p \ra t \geq 0                                 \\
  [-\medskipamount]
  \hrulefill                                      \\
  \HT{p}{\WDD{B}{S}}{p \A \neg\ B}
 \end{array}
\]
%
\NI
where $t$ and $z$ are as above.
\III

Proof system~IV is obtained from proof system~I by replacing the LOOP
I rule by the LOOP~IV rule. The use of two forms of provability in the
premises of this rule can be circumvented by the following
modification of the notation.  Denote the correctness
formulas in the sense of partial correctness by $\HT{p}{S}{q}$ and in
the sense of total correctness by $\HTT{p}{S}{q}$. Then combine the
proof system~I with the proof system in which the axioms and proof
rules of I except the LOOP~I rule are rewritten using the
$\HTT{p}{S}{q}$ syntax. Finally, add to this proof system the LOOP IV
rewritten as follows:
\III

\[
 \begin{array}{l}
  \HT{p \A B}{S}{p},                      \\
  \HT{p \A B \A t=z}{S}{t<z},             \\
  \HTT{p \A B}{S}{\mathbf{true}},         \\
  p \ra t \geq 0                         \\
  [-\medskipamount]
  \hrulefill                              \\
  \HTT{p}{\WDD{B}{S}}{p \A \neg\ B}
 \end{array}
\]

\NI
where $t$ and $z$ are as above.
\III

In what follows we use the original formulation of this rule, 
as it will not lead to any ambiguities.


The final LOOP V rule introduces an additional parameter
in the loop invariant instead of a separate bound function.

\III

\NI
RULE LOOP V
\[
 \begin{array}{l}
 \HT{p(x)\wedge B}{S}{\exists y: p(y)\wedge y< x},          \\
  p(x)\rightarrow x\geq 0                          \\
  [-\medskipamount]
  \hrulefill                                \\
  \HT{\exists x:p(x)}{\WDD{B}{S}}{(\exists x:p(x)) \A \neg\ B}
 \end{array}
\]

\NI
where $x$ is an integer variable which  does not appear
in $\WDD{B}{S}$, and $p(y)$ denotes the result of replacing
$x$ in $p(x)$ by the fresh integer variable $y$.

Note that the outer brackets in $(\exists x:p(x))$ can be dropped thanks to the assumption about the variable $x$.

\subsection{Discussion}

It is difficult to determine where the LOOP II rule was introduced
first. We mentioned it in \cite{ABO90}. It also appears in
\cite{Rey98} on page 64 and in \cite{Almeida11} on page 151.  The LOOP
III rule was introduced in \cite{OG76a}.  It corresponds to Dijkstra's
modification of his weakest precondition semantics proposed in
\cite{EWD:EWD573} and reproduced as %\cite{Dij82}.
\cite{EWD:EWD573pub}.  We used it in our book \cite{ABO09}.

The LOOP IV rule was introduced in \cite{ABO25}.
It formalizes the following intuition. In order to prove the
termination of a \textbf{while} loop it suffices to find a loop
invariant and a bound function such that

\begin{enumerate}[(i)]
 \item the loop invariant is maintained by each loop body execution, 
       in the sense of partial correctness,
 \item each loop body execution decreases the bound function, 
       also in the sense of partial correctness,
 \item the loop body terminates, and
 \item the loop invariant implies that the bound function remains non-negative.
\end{enumerate}

This rule supports modular reasoning about program correctness
by separating the premises into partial correctness and termination
properties.  This is of particular relevance in the presence of nested
loops, i.e., when the loop body contains inner loops.  Then (i)
establishes only the partial correctness of the loop body, whereas its
termination is relegated to (iii). That the loop body can be iterated
only finitely often is established in (ii) in combination with (iv).
Note that for loop bodies without inner loops, partial and total
correctness coincide. In this case the third premise,
$\HT{p \A B}{S}{\mathbf{true}}$, can then be dropped, and we arrive at
the LOOP III rule. So the hybrid form of this rule arises only for
nested loops.




Parameterized loop invariants were first used in a rule proposed
in \cite{Harel79}, where with each loop iteration the parameter was
supposed to decrement exactly by 1.  The above LOOP V rule allows us
to generalize proofs of termination to arbitrary well-founded domains.
Such a generalization is for example required for reasoning about
termination in presence of \emph{countable non-determinism}
\cite{AptP86}.  

It is easy to manufacture a number of alternative LOOP rules. 
Note for example that the LOOP II rule results from combining the first two
premises of the LOOP III into one.  An analogous modification can be
carried out in the case of the LOOP IV rule. 

In \cite{AptP86} a different version of LOOP V rule was used, namely

\[
 \begin{array}{l}
   p(x) \wedge x > 0 \ra B,                         \\
 \HT{p(x)\wedge x > 0}{S}{\exists y: p(y)\wedge y< x},          \\
   p(0) \ra \neg B,                         \\ 
  [-\medskipamount]
  \hrulefill                                \\
  \HT{\exists x:p(x)}{\WDD{B}{S}}{p(0)}
 \end{array}
\]

(In this rule, to deal with unbounded nondeterminism, it was stipulated
that the variable $x$ ranges over ordinals instead over integers.)
We found our LOOP rule V simpler to reason with.

In turn, the following version of LOOP V results from separating the
reasoning about termination along the lines of LOOP IV rule.

\[
 \begin{array}{l}
 \vdash_{\rm{I}}\HT{p(x)\wedge B}{S}{\exists y: p(y)\wedge y< x},          \\
 \HT{(\exists x:p) \wedge B}{S}{\T},\\
  p(x)\rightarrow x\geq 0                          \\
  [-\medskipamount]
  \hrulefill                                \\
  \HT{\exists x:p(x)}{\WDD{B}{S}}{(\exists x:p(x)) \A \neg\ B}
 \end{array}
\]


\III
\NI

THE FOLLOWING  MODIFICATION USED UPFRONT TO EXPLAIN THE GENERAL APPROACH
AS DESCRIBED IN LEMMA 1.

Further, the last premise of each of the LOOP rules II-V and their
variants can also be modified, by considering in each case the
implication $p \A B \ra t \geq 0$ instead of $p \ra t \geq 0$. 
This  modification does not affect provability in
the considered proof systems II-V. 
The following example shows this for the modification of the LOOP II rule,
and uses this case to illustrate our general approach.

\begin{example}
First we observe that the LOOP II rule is trivially derivable
in the modified proof system II, which uses instead its  modified  version,
because 
$p \ra t \geq 0$ implies  $p \A B \ra t \geq 0$.
However, the converse does \emph{not} hold:
Let 
$$
 \HT{p \A B \A t=z}{S}{p \A t<z}
$$
and
$p \A B \ra t \geq 0$.
In order to apply the LOOP II rule
suppose  that there exists a bound function $t'$
such that $p  \ra t' \geq 0$.
Since we can only apply the CONSEQUENCE rule to the above premise
to derive
$$
 \HT{p \A B \A t'=z}{S}{p \A t'<z}
$$
we have that
$(p \A B \A t'=z)\ra (p \A B \A t=z)$
and $(p \A t<z) \ra (p \A t'<z)$.
But the first implication implies that $t=t'$ which does not hold in general.
Take for example $\ITE{B}{t+1}{0}$ for $t'$. 

Instead, using
the standard \emph{substitution} rule which allows to
replace in the above premise $z$ by $z-1$,
we  obtain
% $$
%  \HT{p \A B \A t=z-1}{S}{p \A t<z-1}
% $$
% that is,
$$
 \HT{p \A B \A t+1=z}{S}{p \A t+1<z}
$$
by a trivial application of the CONSEQUENCE rule.
Another application of the  CONSEQUENCE rule then
gives (as above, $t'\equiv \ITE{B}{t+1}{0}$)
$$
 \HT{p \A B \A t'=z}{S}{p \A t+1<z}.
$$
Next we
apply the standard \emph{invariance} rule
to obtain
$$
 \HT{p \A B \A t'=z\A 0< z}{S}{p \A t'<z \A 0<  z}.
$$
A final application of the CONSEQUENCE rule gives
the desired premise 
$$
 \HT{p \A B \A t'=z}{S}{p \A t'<z},
$$
so that we finally can apply the original LOOP II rule.





% It follows that 
% $p\ra \ITE{B}{t}{0}\geq 0$.
% % Thus we only need to derive 
% % $$
% %  \HT{p \A B \A \ITE{B}{t}{0}=z}{S}{p \A \ITE{B}{t}{0}<z}
% % $$
% % from the above premise.
% Clearly, $p \A B \A \ITE{B}{t}{0}=z$ implies
% $p \A B \A t=z$. However  $p \A t<z$ does \emph{not} imply 
% $p \A \ITE{B}{t}{0}<z$: if $B$ does not hold we should
% have that $0<z$, instead we have $0\leq z$.
% Therefore we try the bound function
% $\ITE{B}{t+1}{0}$ which we denote by $t'$.
% But clearly we still cannot 
% derive the corresponding correctness formula
% from the above premise using the  CONSEQUENCE rule.
% In fact, the situation only seems more complicated
% because we have now introduced an \emph{inconsistency} in the meaning
% of the logical variable $z$: On the one hand, the above premise states that
% $t=z$ holds initially, whereas the modified bound function requires
% that $t+1=z$ holds initially.
% To resolve this inconsistency we use
% the standard \emph{substitution} rule which allows to
% replace in the above premise $z$ by $z-1$
% and  obtain
% $$
%  \HT{p \A B \A t=z-1}{S}{p \A t<z-1}
% $$
% that is,
% $$
%  \HT{p \A B \A t+1=z}{S}{p \A t+1<z}
% $$
% by a trivial application of the CONSEQUENCE rule.
% Another application of the  CONSEQUENCE rule then
% gives
% $$
%  \HT{p \A B \A t'=z}{S}{p \A t+1<z}.
% $$
% Still $p \A t+1<z$ does not imply
% $p \A \ITE{B}{t+1}{0}<z$.
% Therefore we
% apply the standard \emph{invariance} rule
% to obtain
% $$
%  \HT{p \A B \A t'=z\A 0< z}{S}{p \A t'<z \A 0<  z}.
% $$
% A final application of the CONSEQUENCE rule gives
% the desired premise 
% $$
%  \HT{p \A B \A t'=z}{S}{p \A t'<z},
% $$
% so that we finally can apply the original LOOP II rule.
\end{example}

The above example thus shows that the modified LOOP II rule is derivable
in the proof system II, using  auxiliary rules.
In contrast to the \bfe{structural} rules in Hoare logics,
e.g., the rules for the different programming constructs, these
rules abstract from the program structure.
Instead, these rules  allow to
\emph{adapt}  pre- and postconditions in ways beyond
the basic  weakening and strengthening of the CONSEQUENCE rule.
As such these rules are  not simply derivable.
To finally show that the proof system II is equivalent
with the system consisting of  the modified LOOP rule II,
as stated by Lemma \ref{lem:equiv} it therefore remains to show that these auxiliary rules
are \emph{admissible} in the proof system II and its modified version.






\III
\NI

THE DISCUSSION OF THE UNRESTRICTED RULES IS CHANGED

A careful reader will notice that in the LOOP II, III and IV rules we
imposed the restriction $var(t) \subseteq \mbox{\it pvar}$ on the
variables of the bound function $t$ that is absent in the publications
that use the LOOP II and III rules. We added this restriction to
simplify the subsequent proofs.  

% However, it is inessential as the
% following theorem shows, where we call the LOOP rules II-IV without
% this stipulation \emph{unrestricted}.

% \begin{theorem} \label{thm:book}
%   \mbox{} \\
%   The unrestricted rules LOOP II, III, and IV, are admissible in the
%   proof system II, III, and IV, respectively.
% \end{theorem}

% The proof can be found in Appendix~\ref{LOOPIIt}.
However, it is inessential as the unrestricted rules LOOP II, III, and IV, are admissible in the
  proof systems II, III, and IV, respectively.
This follows from Theorem \ref{thm:aux}
and Lemma \ref{lem:unrestr} in the following Section
\ref{subsec:aux}, using our general approach described above.

\NI

END



\III
\NI
SLIGHTLY CHANGED

We will restrict our proof-theoretic analysis to the LOOP rules
II-V. As 
the above  results already show,
it is straightforward to apply our general approach to the discussed modifications of them.

\NI
END
\subsection{Auxiliary Rules}
\label{subsec:aux}

In the proof-theoretic analysis of the LOOP II and III rules, we make
use of the following two auxiliary rules, see, e.g., \cite{ABO09}.
\III

\NI
RULE \label{rul:conj} CONJUNCTION
\[ 
 \frac{ \HT{p_1}{S}{q_1}, \HT{p_2}{S}{q_2}     }
      { \HT{p_1 \A p_2}{S}{q_1 \A q_2}         } 
\]
\NI
RULE \label{rul:intro} $\te$-INTRODUCTION
\[ 
 \frac{ \HT{p}{S}{q}          }
      { \HT{\te z:p}{S}{q}    }
\]
\NI
CHANGED

where $z$ is a \emph{logical} variable that does not occur  in $\mathit{free}(q)$.

\NI
END
\III

To reason about the LOOP IV rule
we consider the following auxiliary rules that relate provability
in two proof systems.

\III

\NI
RULE PARTIAL CORRECTNESS
\[
 \begin{array}{l}
   \HT{p}{S}{q}\\
  [-\medskipamount]
  \hrulefill                         \\
  \vdash_{\rm{I}} \HT{p}{S}{q}
  \end{array}
\]

\III

\noindent
RULE HYBRID CONJUNCTION
\[
 \begin{array}{l}
  \vdash_{\rm{I}} \HT{p_1}{S}{q_1},   \\
  \HT{p_2}{S}{q_2}                    \\
  [-\medskipamount]
  \hrulefill                          \\
  \HT{p_1 \A p_2}{S}{q_1 \A q_2}
 \end{array}
\]





A special case of this kind of rule is the following rule from \cite{ABO09}.
\III

\noindent
RULE DECOMPOSITION
\[
 \begin{array}{l}
  \vdash_{\rm{I}} \HT{p}{S}{q},      \\
  \HT{p}{S}{\T}                      \\
  [-\medskipamount]
  \hrulefill                         \\
  \HT{p}{S}{q}
  \end{array}
\]

\III
\NI
SUBSTITUTION RULE ADDED

Finally, to reason about the LOOP V rule we have the following
SUBSTITUTION rule, see, e.g., \cite{ABO09}.

\III
\NI
RULE \label{rul:SUBST} SUBSTITUTION
\[ 
 \frac{ \HT{p}{S}{q}          }
      { \HT{p[x:=t]}{S}{q[x:=t]}    }
\]
where $x$ is a logical or program variable
that does not occur in $S$ and $\mbox{\it var}(t)\cap \mbox{\it var}(S)=\emptyset$ ($t$ thus may contain logical variables).

\NI
END

\III
\NI
ADDED IN THIS SECTION. THE APPENDIX ABOUT UNRESTRICTED BOUND FUNCTIONS  DISAPPEARS.

The following theorem states that these rules are indeed auxiliary
in the formal sense of admissibility.


\begin{theorem}\label{thm:aux}
The above auxiliary rules 
are admissible in each proof system I-V.
\end{theorem}

Though tedious this is rather straightforward to prove.  In 
Appendix \ref{sec:proof} we only prove those cases which are actually
needed in the proof of the main Theorem \ref{thm:main} (see the next
section).

As a simple example of the use of the auxiliary rules, we
have the following lemma about the \emph{unrestricted} LOOP rules II-IV, which cater for
bound functions $t$ that  may refer also to logical variables.

\III
\NI
LEMMA 2 REFORMULATED



\begin{lemma}\label{lem:unrestr}
Each unrestricted LOOP rule II-IV is derivable 
in the corresponding proof system II-IV, extended with the SUBSTITUTION rule.
\end{lemma}

\begin{proof}
We show the case of the unrestricted LOOP II rule.
Given the premise
$$
 \HT{p \A B \A t=z}{S}{p \A t<z}  
$$
of the unrestricted LOOP II rule
and that $p \ra t \geq 0$, 
we first apply the SUBSTITUTION rule
to obtain
$$
 \HT{p' \A B \A t'=z}{S}{p \A t'<z}  
$$
where $p'$ and $t'$ result from replacing every
logical variable that appears in $t$ by a fresh
\emph{program} variable.
Now we can apply the restricted LOOP II rule to derive
$$
\HT{p'}{\WDD{B}{S}}{p'\wedge \neg B}
$$
from which we derive the desired conclusion
$\HT{p}{\WDD{B}{S}}{p\wedge \neg B}$,
simply by
another application of the SUBSTITUTION rule, undoing
the renaming of the logical variables appearing in $t$.
\HB 
\end{proof}

\NI

This lemma together with the above Theorem \ref{thm:aux}
implies that the  unrestricted versions of the LOOP rule 
II-IV are \emph{admissible} in the corresponding
proof systems II-IV.

\NI
END

\section{Derivability of the LOOP Rules}

THIS SECTION IS REWRITTEN FROM THE PERSPECTIVE OF DERIVABILITY.




We will show in this section that each of the LOOP rules 
II-V can be derived from any other LOOP rule II-V, using auxiliary rules (Theorem \ref{thm:main}).
From Lemma \ref{lem:equiv}  it then follows that
the corresponding proof systems  \emph{extended} with  auxiliary
rules are equivalent.
From Theorem \ref{thm:aux} we then conclude that
the proof systems II-V are equivalent.




\III
\NI
INTEGRATED LEMMA 2 (AS NUMBERED IN A PREVIOUS VERSION)  
IN THE MAIN THEOREM (LEMMA 3, PREVIOUSLY)


The following main theorem states the equivalence of the LOOP II-V
rules in the strongest way.

\III
\NI
THEOREM REFORMULATED.

\begin{theorem} \label{thm:main}
Each of the LOOP rules 
II-V is derivable in any of the proof systems II-V, extended with the auxiliary rules.
\end{theorem}

\begin{proof}
By Lemma \ref{lem:equiv} and the transitivity of the notion of derivability, that is, if $R$ is derivable in
$\mbox{\it PR}\cup \{R_1\}$ and $R_1$ is derivable in $\mbox{\it PR}\cup \{R_2\}$ then if $R$ is derivable in
$\mbox{\it PR}\cup \{R_2\}$,
it suffices to prove the following.

\III
\NI
THE CASES BELOW REFORMULATED.

\begin{enumerate} [(i)]
   \item The LOOP II rule is derivable in the proof system III, extended with
   the  $\exists$-INTRODUCTION rule.

   \item The LOOP III rule is derivable in the proof system II, extended with
   the   CONJUNCTION  rule.

   \item The LOOP IV rule is derivable in the proof system III, extended with
   the  HYBRID CONJUNCTION rule.

   \item The LOOP III rule is derivable in the proof system IV, extended with
   the  PARTIAL CORRECTNESS  rule.
   
  

   \item The LOOP V rule is derivable   in the proof system LOOP II, extended with
   the  SUBSTITUTION rule.
   
   

   \item The LOOP II  is derivable in the proof system  V.
   


  \end{enumerate}
\mbox{} \\
\NI
$(i)$ From the premise
\[
  \HT{p \A B \A t=z}{S}{p \A t<z}
\]
of the LOOP II rule
we first derive 
by the CONSEQUENCE rule 
both
\[
 \HT{p \A B \A t=z}{S}{p} \quad \mbox{\rm and} \quad
\HT{p \A B \A t=z}{S}{t<z}.
\]
Next, by the $\te$-INTRODUCTION rule, we derive 
\[
 \HT{\te z: p \A B \A t=z}{S}{p}.
\]
from
$\HT{p \A B \A t=z}{S}{p}$.
Since $z$ is a logical variable that does not appear
free in $p$ or $t$ (note that by assumption $\mbox{\it var}(t)\subseteq \mbox{\it pvar}$), we have
\[
  p \A B \to (p \A B \A \te z: t=z) \to  (\te z: p \A B \A t=z),
\]
(note that by definition also $\mbox{\it var}(B)\subseteq \mbox{\it pvar}$).
By the CONSEQUENCE rule, we derive the premise
$\HT{p \A B}{S}{p}$ of the LOOP III rule.

Since by assumption $p \ra t \geq 0$ holds, we can apply
the LOOP III rule to obtain the desired conclusion
$\HT{p}{\WDD{B}{S}}{p \A \neg B}$.

\III

\NI
$(ii)$ From the premises 
\[
  \HT{p \A B} {S}{p}\quad \mbox{\rm and} \quad
   \HT{p \A B \A t=z}{S}{t<z}
\]
of the LOOP III rule we derive 
\[
  \HT{p \A B \A t=z}{S}{p \A t<z}
\]
by the CONJUNCTION and
the CONSEQUENCE rule. 
Since by assumption $p \ra t \geq 0$ holds, we can apply
the LOOP II rule to obtain the desired conclusion
$\HT{p}{\WDD{B}{S}}{p \A \neg B}$.
\III

\NI
$(iii)$ 
From the premises 
\[
  \vdash_{\rm{I}}  \HT{p \A B}{S}{p},\quad
  \vdash_{\rm{I}}  \HT{p \A B \A t=z}{S}{t<z},\quad
\mbox{\rm and} \quad
 \HT{p \A B}{S}{\mathbf{true}}
\]
of the LOOP IV rule
we derive 
$$\HT{p \A B}{S}{p} \quad
\mbox{\rm and} \quad
\HT{p \A B \A t=z}{S}{t<z}$$
by two applications of the HYBRID CONJUNCTION rule.
Since by assumption $p \ra t \geq 0$ holds, we can apply
the LOOP III rule to obtain the desired conclusion
$\HT{p}{\WDD{B}{S}}{p \A \neg B}$.
\III

\NI
$(iv)$ From the premises
\[
  \HT{p \A B}{S}{p}
\quad
\mbox{\rm and} \quad
   \HT{p \A B \A t=z}{S}{t<z},
\]
of the LOOP III rule
we obtain
$$\vdash_{\rm{I}}  \HT{p \A B}{S}{p}
\quad
\mbox{\rm and} \quad \vdash_{\rm{I}}  \HT{p \A B \A t=z}{S}{t<z}$$
by applying the PARTIAL CORRECTNESS rule.
By the CONSEQUENCE rule, we also have
$$ \HT{p \A B}{S}{\mathbf{true}}.$$
Since by assumption $p \ra t \geq 0$ holds, we can apply
the LOOP IV rule to obtain the desired conclusion
$\HT{p}{\WDD{B}{S}}{p \A \neg B}$.
\III


\NI
$(v)$ 
Given the premises
$$\HT{p(x)\wedge B}{S}{\exists y: p(y)\wedge y< x}$$
and $p(x)\rightarrow x\geq 0$ of the LOOP V rule,
we want to introduce a \emph{Skolem function}   $f(\bar{u})$,
where $\bar{u}$ denotes the list of  free variables of $p(x)$,  the variable $x$ excluded,
and define  $t\equiv f(\bar{u}) $ as the bound function
such that
$(\exists x:p(x))\rightarrow p(f(\bar{u}))$
and $p(x)\rightarrow f(\bar{u})\leq x $. 
So
$f(\bar{u})$ denotes the minimal witness, which exists
because 
$p(x)\rightarrow x\geq 0$.
However, in case $p(x)$ contains logical variables
this representation does not satisfy the requirement
that $\mbox{\it var}(t)\subseteq\mbox{\it pvar}$.
Therefore we first apply the SUBSTITUTION rule to obtain
$$\HT{p'(x)\wedge B}{S}{\exists y: p'(y)\wedge y< x}$$
where $p'(x)$ results fro replacing every logical variable
in $p(x)$ (excluding $x$) by a fresh \emph{program} variable.
Let $\bar{u}$ denote the list of free variables of $p'(x)$
and $f(\bar{u})$ be a Skolem function such that
$(\exists x:p'(x))\rightarrow p'(f(\bar{u}))$
and $p'(x)\rightarrow f(\bar{u})\leq x $. 
It follows that
$$
(\exists y: p'(y)\wedge y< x)\to
((\exists x:p'(x)) \wedge f(\bar{u})< x)
$$
and
$$
((\exists x:p'(x)) \wedge f(\bar{u})=x)\to
p'(x).
$$
An application of
the CONSEQUENCE rule then
gives
$$\HT{(\exists x:p'(x))\wedge B\wedge f(\bar{u})=x}{S}{(\exists x:p'(x))\wedge f(\bar{u})<x}.$$
Further, we have $(\exists x:p'(x)) \rightarrow f(\bar{u})\geq 0$.
So we can apply 
the LOOP II rule with $t \equiv f(\bar{u})$ to obtain 
$\HT{\exists x: p'}{\WDD{B}{S}}{\exists x:p'  \A \neg B}$.
Finally, we obtain the desired conclusion
$\HT{\exists x: p}{\WDD{B}{S}}{\exists x:p  \A \neg B}$
by an application of the SUBSTITUTION rule.






\III

\NI
$(vi)$ Given the premises
$$\HT{p\wedge B\wedge t=z}{S}{p\wedge t<z}$$
and $p\rightarrow t\geq 0$ of the LOOP II rule.
Let
$p'(z)$ denote the assertion $p\wedge t=z$.

Then for any fresh variable $y$ the implication
$(p\wedge t<z)\rightarrow \exists y:p\wedge t=y \wedge y<z)$ holds.
By the CONSEQUENCE rule we thus obtain
$$\HT{p'(z)\wedge B}{S}{\exists y: p'(y)\wedge y< z}.$$

Further, $p\rightarrow t\geq 0$ implies
$p'(z)\rightarrow z\geq 0$.
So applying the LOOP V rule we obtain 
$$\HT{\exists z:p'}{\WDD{B}{S}}{(\exists z:p') \wedge  \neg B}.$$

But $(\exists z:p')\leftrightarrow p$, 
so by a trivial  application of the CONSEQUENCE rule
we derive the desired conclusion
$\HT{p}{\WDD{B}{S}}{p \wedge \neg B}$.
\HB
\end{proof}




% \begin{theorem} \label{thm:main}
%   \mbox{}
%   \begin{enumerate}[(i)]
%   \item The proof systems II, III, IV and V are equivalent.

%   \item Each LOOP $\alpha$ rule is admissible in the proof system $\beta$, 
%         where $\alpha, \beta \in \{\mathrm{II, III, IV, V}\}$.
%   \end{enumerate}
% \end{theorem}

% To prove this result we establish first two lemmas.  The following one
% refers to the premises of the LOOP II and LOOP III rules. The names of
% the rules are abbreviated in the obvious way.

% \begin{lemma} \label{lem:1}
% Suppose that $z$ is an integer variable that
% does not appear in $p,B,t$ or $S$.
% Then
%   \begin{enumerate} [(i)]
%    \item 
%      \quad $\HT{p \A B} {S}{p}, \ \HT{p \A B \A t=z}{S}{t<z}$ \\
%      $\vdash_{\{\rm{CONJ}, \, \rm{CONS}\}}$ \\
%      \mbox{} \quad $\HT{p \A B \A t=z}{S}{p \A t<z}$.
    
%    \item
%      \quad $\HT{p \A B \A t=z}{S}{p \A t<z}$ \\
%      $\vdash_{\{\exists -{\rm INTRO}, \, \rm{CONS}\}}$ \\
%      \mbox{} \quad $\HT{p \A B}{S}{p}, \ \HT{p \A B \A t=z}{S}{t<z}$.

%   \end{enumerate}
% \end{lemma}

% \begin{proof}
%   \mbox{}\\
%   \NI
% $(i)$ Immediate. 
% \III

% \NI
% $(ii)$
% First note that by the CONSEQUENCE rule we can derive
% from
% \[
%  \HT{p \A B \A t=z}{S}{p \A t<z}
% \]
% both
% \[
%  \HT{p \A B \A t=z}{S}{p}
% \]
% and
% \[
% \HT{p \A B \A t=z}{S}{t<z}.
% \]

% Next, by the $\te$-INTRODUCTION rule, we derive from
% $\HT{p \A B \A t=z}{S}{p}$
% \[
%  \HT{\te z: p \A B \A t=z}{S}{p}.
% \]
% By the assumption about the variable $z$,
% \[
%   p \A B \to (p \A B \A \te z: t=z) \to  (\te z: p \A B \A t=z),
% \]
% so by the CONSEQUENCE rule, we derive $\HT{p \A B}{S}{p}$, as desired.
% \HB
% \end{proof}

% Next, we isolate the claims of Theorem \ref{thm:main}$(ii)$ that turn
% out to be sufficient to prove the remaining ones.


% \begin{theorem}\label{thm:main}
% The loop rules are admissible in the other proof systems as follows:

%   \begin{enumerate} [(i)]
%    \item The LOOP II rule is admissible in the proof system III.

%    \item The LOOP III rule is admissible in the proof system II.

%    \item The LOOP IV rule is admissible in the proof system III.

%    \item The LOOP III rule is admissible in the proof system IV.

%    \item The LOOP V rule is admissible in the proof system II.

%    \item The LOOP II rule is admissible in the proof system V.

%   \end{enumerate}

% \end{theorem} 

% \begin{proof}
% \mbox{} \\
% \NI
% $(i)$ Suppose
% \[
%   \vdash_{\rm III} \HT{p \A B \A t=z}{S}{p \A t<z}
% \]
% and that
% $p \ra t \geq 0$ holds.
% By Lemma \ref{lem:1}$(ii)$,
% \[
%   \vdash_{\rm{III}\, \cup\, \{\exists -{\rm INTRO}, \ \rm{CONS}\}} \HT{p \A B} {S}{p}\]
% and
% \[
%   \vdash_{\rm{III}\, \cup\, \{\exists -{\rm INTRO}, \ \rm{CONS}\}} \HT{p \A B \A t=z}{S}{t<z}.
% \]
% By Theorem \ref{thm:aux}
% $\vdash_{\rm III} \HT{p \A B} {S}{p}$ and
% $\vdash_{\rm III} \HT{p \A B \A t=z}{S}{t<z}$, 
% so by the LOOP III rule
% $\vdash_{\rm III} \HT{p}{\WDD{B}{S}}{p \A \neg B}$.
% \III

% \NI
% $(ii)$ Suppose
% \[
%   \vdash_{\rm II} \HT{p \A B} {S}{p},
% \]
% \[
%   \vdash_{\rm II} \HT{p \A B \A t=z}{S}{t<z},
% \]
% and that
% $p \ra t \geq 0$ holds.
% By Lemma \ref{lem:1}$(i)$,
% \[
%   \vdash_{\rm{III}\, \cup\, \{\rm{CONJ},\,\rm{CONS}\}} \HT{p \A B \A t=z}{S}{p \A t<z}.
% \]
% By Theorem \ref{thm:aux}
% $\vdash_{\rm II} \HT{p \A B \A t=z}{S}{p \A t<z}$, so by the LOOP II rule
% $\vdash_{\rm II} \HT{p}{\WDD{B}{S}}{p \A \neg B}$.
% \III

% \NI
% $(iii)$ 
% Suppose
% \[
%   \vdash_{\rm{I}}  \HT{p \A B}{S}{p},
% \]
% \[
%   \vdash_{\rm{I}}  \HT{p \A B \A t=z}{S}{t<z},
% \]
% \[
%   \vdash_{\rm{III}} \HT{p \A B}{S}{\mathbf{true}},
% \]
% and that
% $p \ra t \geq 0$ holds. By Theorem \ref{thm:aux} applied twice
% $\vdash_{\rm III} \HT{p \A B}{S}{p}$
% and
% $\vdash_{\rm III} \HT{p \A B \A t=z}{S}{t<z}$.

% So by the LOOP III rule
% $\vdash_{\rm III} \HT{p}{\WDD{B}{S}}{p \A \neg B}$.
% \III

% \NI
% $(iv)$ Suppose
% \[
%   \vdash_{\rm{IV}}  \HT{p \A B}{S}{p},
% \]
% \[
%   \vdash_{\rm{IV}}  \HT{p \A B \A t=z}{S}{t<z},
% \]
% and that
% $p \ra t \geq 0$ holds. 
% By omitting everywhere in these two proofs 
% the second and third premise of the LOOP IV rule whenever this rule is applied, we get
% $\vdash_{\rm{I}}  \HT{p \A B}{S}{p}$ and
% $\vdash_{\rm{I}}  \HT{p \A B \A t=z}{S}{t<z}$. 
% Further, by the CONSEQUENCE rule
% $\vdash_{\rm{IV}}  \HT{p \A B}{S}{\mathbf{true}}$.

% So by the LOOP IV rule
% $\vdash_{\rm IV} \HT{p}{\WDD{B}{S}}{p \A \neg B}$.
% \III


% \NI
% $(v)$ Suppose
% $$\vdash_{\rm{II}}\HT{p(x)\wedge B}{S}{\exists y: p(y)\wedge y< x}$$
% and $p(x)\rightarrow x\geq 0$.
% Let $\bar{u}$ be the list of free variables of $p(x)$
% different from $x$ and let $f(\bar{u})$  be a \emph{Skolem function}
% such that
% $(\exists x:p(x))\rightarrow p(f(\bar{u}))$
% and $p(x)\rightarrow f(\bar{u})\leq x $. So
% $f(\bar{u})$ denotes the minimal witness, which exists
% because 
% $p(x)\rightarrow x\geq 0$.

% BEGIN SLIGHTLY REWORDED (14--01-26)

% It follows that the implications
% $\exists y: p(y)\wedge y< x \ra (\exists x:p(x)) \wedge f(\bar{u})< x$ and
% $(\exists x:p(x)) \wedge f(\bar{u})=x \ra p(x)$ hold. 
% Thus by the CONSEQUENCE rule
% we derive 
% $$\vdash_{\rm{II}}\HT{(\exists x:p(x))\wedge B\wedge f(\bar{u})=x}{S}{(\exists x:p(x))\wedge f(\bar{u})<x}$$
% from the above premise of the LOOP V rule.
% Further, we have $(\exists x:p(x)) \rightarrow f(\bar{u})\geq 0$.

% However, in general $\bar{u}\not\subseteq var(B)\cup var(S)$, so we
% cannot apply now the LOOP II rule with $t \equiv f(\bar{u})$.
% The way out is offered by Theorem \ref{thm:book} that allows us to
% apply the unrestricted version of this rule to obtain
% $$\vdash_{\rm{II}} \HT{\exists x:p(x)}{\WDD{B}{S}}{\exists x:p(x) \wedge \neg B}.$$

% END SLIGHTLY REWORDED (14--01-26)
% \III

% \NI
% $(vi)$ Suppose
% $$\vdash_{\rm{V}}\HT{p\wedge B\wedge t=z}{S}{p\wedge t<z}$$
% and $p\rightarrow t\geq 0$.
% Let
% $p'(z)$ denote the assertion $p\wedge t=z$.

% Then for any fresh variable $y$ the implication
% $(p\wedge t<z)\rightarrow \exists y:p\wedge t=y \wedge y<z)$ holds.
% By the CONSEQUENCE rule we thus obtain
% $$\vdash_{\rm V}\HT{p'(z)\wedge B}{S}{\exists y: p'(y)\wedge y< z}.$$

% Further, $p\rightarrow t\geq 0$ implies
% $p'(z)\rightarrow z\geq 0$.
% So we obtain 
% $$\vdash_{\rm V}\HT{\exists z:p'}{\WDD{B}{S}}{(\exists z:p') \wedge  \neg B}.$$

% But $(\exists z:p')\leftrightarrow p$, 
% so by a trivial  application of the CONSEQUENCE rule
% we conclude that 
% $$\vdash_{\rm V}\HT{p}{\WDD{B}{S}}{p \wedge \neg B}.$$
% \HB
% \end{proof}


% We can now establish Theorem \ref{thm:main}.
% \III

%   \NI
%   $(i)$   The equivalence relation between proof systems is transitive, so
%   the claim follows by Lemmata \ref{lem:equiv} and \ref{lem:main}.

% \III
  
%   \NI
%   $(ii)$
%   Take a LOOP $\alpha$ rule and a proof system $\beta$, where
%   $\alpha, \beta \in \{\mathrm{II, III, IV, V}\}$.
%   By part $(i)$, $\alpha$ and $\beta$
%   are equivalent. So by Lemma \ref{lem:equiv}, the LOOP $\alpha$
%   rule is admissible in the proof system $\beta$.
%   \HB

\section{Soundness and Completeness Matters}
Assume now that some notion of semantics of programs and assertions is given 
that includes the concept of a state, execution of a program,
the notion of a state satisfying an assertion, and the truth of an assertion.
We write then $\models \HT{p}{S}{q}$ to denote the fact that every execution of $S$ 
that starts in a state satisfying $p$ terminates in a state satisfying $q$ 
and say then that $\HT{p}{S}{q}$ is \bfe{true}.
(Thus we are referring to \bfe{total correctness}.)
Next, we say then that a proof rule
\[
  \frac{\varphi_1,\LL,\varphi_k}{\varphi}
\]
is \bfe{sound} if
$\models \varphi_1,\LL, \models \varphi_k$ implies $\models \varphi$.

In \cite{ABO09} we proved that the LOOP III rule is sound, while in \cite{Rey98} 
it was proved that the LOOP II is sound. A natural question arises 
whether soundness of one of these rules can be directly deduced from
the soundness of the other rule. 

\III
\NI
ADDED

This deduction follows from the derivability results stated
in the  main Theorem \ref{thm:main} and the soundness of the
auxiliary rules.
For example, suppose now that the LOOP II rule is sound.
Since the LOOP III rule is derivable from the
LOOP II rule, its soundness  follows directly from 
 the soundness of the LOOP II rule and the soundness
 of the auxiliary rules, in particular of
 the 
CONSEQUENCE rule.

\NI
END

% Further, we can derive for  soundness
% of the LOOP II rule from the soundness of the LOOP V rule,
% using the derivability result of clause (vI).
% However, this approach breaks down for the soundness
% of the LOOP V rule itself, because Theorem \ref{lem:main} does not
% provide a corresponding derivability result.
% The `invasive' notion of admissibility does not allow
% such a reduction of the soundness of the LOOP V rule
% to that of the LOOP II rule.
% Note that the showstopper here is the restriction
% on the term $t$ in the LOOP rule II,
% which on the other hand is needed for ther admissibility
% of the $\exists$-INTRODUCTION rule.

% This can be accomplished by  modifying the claims of Lemma \ref{lem:1} as follows.

% \begin{lemma} \label{lem:2}
% Suppose that $z$ is an integer variable that
% does not appear in $p,B,t$ or $S$.
% Then
%   \begin{enumerate} [(i)]
%   \item 
%     If $\models \HT{p \A B} {S}{p}$ and $\models \HT{p \A B \A t=z}{S}{t<z}$, \\ 
%     then $\models \HT{p \A B \A t=z}{S}{p \A t<z}$.
    
%   \item
%     If \ $\models \HT{p \A B \A t=z}{S}{p \A t<z}$, \\ 
%     then $\models \HT{p \A B} {S}{p}$ and $\models \HT{p \A B \A t=z}{S}{t<z}$.

%   \end{enumerate}
% \end{lemma}

% \begin{proof}
%   It is a direct consequence of the fact that the proof rules used 
%   in Lemma~\ref{lem:1} are sound. Thus each time one of these rules
%   is applied, truth of the correctness formulas is preserved. 
%   \HB
% \end{proof}

% Suppose now that the LOOP II rule is sound. To prove the soundness 
% of the LOOP III rule assume that its premises are true. 
% Then by Lemma \ref{lem:2}$(i)$ the premises of the LOOP II rule are true, 
% so by its soundness the conclusion of both rules is true.
% The same argument shows that soundness of the LOOP III rule 
% implies soundness of the LOOP II rule.

% Finally, for the rules LOOP II--IV we assumed that the bound function $t$ satisfies 
% the restriction $var(t) \subseteq var(B) \cup var(S)$.
% This allows for the proof of admissibility of the $\exists$-INTRODUCTION rule 
% in Theorem~\ref{thm:aux}, which in turn is used via Lemma~\ref{lem:1} 
% in the proof of Lemma~\ref{lem:main}
% and thus in the proof of the equivalence result stated in Theorem~\ref{thm:main}.
% In future we will investigate how to avoid this restriction.
% We see that the equivalence of the different proof systems for total correctness
% depends very subtly on the intricate interplay of the loop rules with 
% the admissibility of standard auxiliary rules of Hoare's logic,
% which requires further investigation.



\subsection{Completeness}

\NI 

SECTION ON COMPLETENESS ADDED


Next we discuss  \emph{completeness} of the proof systems II, III, IV, and V.
Since these proof systems are equivalent, it 
suffices to prove completeness for one of them.
We opt here for the proof system V 
for which
we consider the standard notion of \emph{relative}
completeness: For any first-order model $M$ of the assertion language
we will show that  $M\models\HT{p}{S}{q}$
implies  $T(M)\vdash_{\rm{V}}\HT{p}{S}{q}$, where
$T(M)$ denotes the first-order theory of $M$,
for use in the consequence rule.
Here  $M\models\HT{p}{S}{q}$ defines the truth of 
$\HT{p}{S}{q}$ in terms of the model $M$, that is,
the basic notions of states, executions and satisfaction of the first-order formulas are defined in terms of the model $M$.

We restrict to models $M$ for which 
we can express in the assertion language
the \emph{weakest precondition} $\mbox{\it wp}(S,q)$, for any statement
$S$ and postcondition $q$.
This weakest precondition $\mbox{\it wp}(S,q)$ denotes the set
of initial states for which $S$ terminates in a final state
satisfying $q$.
We refer to Section \ref{sec:WP}
for the standard weakest precondition calculus.
Further, we restrict to models for which there exists
% that these models include a well-founded
% relation $<$ for the interpretation of the corresponding
% relation symbol in the LOOP V rule, and 
a parameterized extension $p(x)$
 of  $\mbox{\it wp}(\WDD{B}{S},q)$, for some   fresh variable $x$
 not appearing in $\WDD{B}{S}$ or $q$.
This parameterized extension 
implies $x\geq 0$ and
satisfies 
the following equivalences.

% \begin{equation}\label{eq:wp1}
% \mbox{\it wp}(\WDD{B}{S},q) \leftrightarrow
% \exists x: \mbox{\it wp}(x,\WDD{B}{S},q)   
% \end{equation}

\begin{equation}\label{eq:wp1}
(\exists x: p(x)) \leftrightarrow
\mbox{\it wp}(\WDD{B}{S},q) 
\end{equation}


\begin{equation}\label{eq:wp2}
p(x)\leftrightarrow
(((\neg B)\wedge q)\vee (B\wedge \mbox{\it wp}(S, \exists y: p(y) \wedge y<x )))
\end{equation}

Instead of representing the bound function by a term $t$
we thus use in the parameterized extension of the weakest precondition a variable $x$
to denote an upper-bound of the number of iterations.




\begin{theorem}\label{thm:comp}
For any model $M$ for which there exists
a parameterized extension 
for every  weakest precondition of a loop statement
and postcondition, we have that
$M\models\HT{p}{S}{q}$ implies
$T(M)\vdash_{\rm{V}}\HT{p}{S}{q}$.
\end{theorem}

\begin{proof}
It suffices to show that
$T(M)\vdash_{\rm{V}}\HT{\mbox{\it wp}(S,q)}{S}{q}$,
for any $S$ and postcondition $q$, because $M\models\HT{p}{S}{q}$
if and only if $p\rightarrow \mbox{\it wp}(S,q)\in T(M)$,
by definition.
The proof proceeds by induction on $S$.

We treat the main case of a loop statement $\WDD{B}{S}$
(the other cases follow directly from the induction hypotheses using the compositional characterization
of the weakest precondition described in Section \ref{sec:WP}).
% For notational convenience, let $p(x)$ abbreviate
% $\mbox{\it wp}(x,\WDD{B}{S},q)$.
Let $p(x)$ denote the parameterized extension of
$\mbox{\it wp}(\WDD{B}{S},q)$.
By the induction hypothesis
we have
\[
\vdash_{\rm{V}}
\HT{\mbox{\it wp}(S, \exists y: p(y) \wedge y<x )}{S}{\exists y: p(y) \wedge y<x }
\]
Applying the consequence rule, using Equivalence (\ref{eq:wp2}), then gives
\[
\vdash_{\rm{V}}
\HT{p(x)\wedge B}{S}{\exists y: p(y) \wedge y<x }
\]
Now we can apply the LOOP V rule and obtain
\[
\vdash_{\rm{V}}
\HT{\exists x:p(x)}{S}{\exists x:p(x)\wedge \neg B}
\]
By a final application of the consequence rule, using Equivalence
(\ref{eq:wp1}) and that $\mbox{\it wp}(\WDD{B}{S},q)\wedge \neg B$ implies
$q$,
we obtain the desired result
\[
\vdash_{\rm{V}}
\HT{\mbox{\it wp}(\WDD{B}{S},q)}{S}{q}
\]

\III
\HB
\end{proof}

For a deterministic language,  for example the one considered in this paper, 
the standard weakest precondition in fact amounts to the existence
of a terminating computation.
The  parameterized extension of the  standard weakest precondition 
of a loop statement then additionally expresses
the number of iterations of 
the (outer) loop.
Clearly in this case both the  Equivalences (\ref{eq:wp1})
and (\ref{eq:wp2}) hold.
Further, using standard coding techniques, we can show
the expressibility of the standard weakest precondition and its parameterized
extension for 
the standard model of Peano arithmetic.

\NI
ADDED A DISCUSSION ON SKOLEM FUNCTIONS.

Since the proof systems II-V are equivalent,
completeness of the proof system V implies completeness
of the proof systems II-IV.
However, the proof of this equivalence, i.e., the proof of Theorem
\ref{thm:main},
notably between the proof systems II and V, is based on the representation
of the bound function by  a Skolem function.
Therefore, to transfer the completeness result for
the proof system V, we have to extend the notion of expressibility
by further restricting to
models which include for every assertion a corresponding
Skolem function.


\III
\NI
UNBOUNDED NONDETERMINISM: TO BE INCLUDED IN THE SECTION ON EXTENSIONS

The  Equivalences (\ref{eq:wp1}) 
and (\ref{eq:wp2}) also hold for  \emph{bounded} non-deterministic  extensions,
for example, extensions with a non-deterministic choice statement
$S_1+ S_2$ or Dijkstra's  guarded command language.
For such languages the  additional parameter then 
denotes  an \emph{upper-bound} of the number of iterations
(of the loop statement).

In programming languages which give rise to
\emph{unbounded} non-determinism  such an upper-bound may not exist.
For example
when the programming language 
features  a random assignment  which gives
rise to \emph{countable} non-determinism (see \cite{AptP86}).
To reason about termination of such programs it suffices
to consider models which include the initial segment of the \emph{ordinals}
consisting of all \emph{countable} ordinals.
For such models the variable $x$ of the LOOP V rule ranges
over this initial segment, $<$ denotes the membership relation,
and $0$ denotes the empty set.
A consequence of this generalization is that we cannot extend the usual coding techniques
to  express  the standard weakest precondition and its parameterized extension 
for loop statements, simply because
the set of all countable ordinals is itself \emph{uncountable}.
As with the general case of program correctness over 
abstract data types, one needs more expressive
assertion languages, e.g., quantification over finite sequences
(as proposed in \cite{TZ88}).
Here we resort to an extension of first-order logic
with a \emph{least fix-point operator}.
This allows to \emph{define} the weakest precondition $\mbox{\it wp}(S,q)$
by induction on $S$ and define
$\mbox{\it wp}(\WDD{B}{S},q)$ by 
$\exists x: p(x)$, where
$p(x)$ is defined by
$$
\mu R(x,\bar{z}):
(\neg B)\wedge q)\vee (B\wedge \mbox{\it wp}(S, \exists y:R(y,\bar{z})  \wedge y<x ))
$$
Here $\bar{z}$ denote the (free) variables of $\WDD{B}{S}$ and $q$.
This formula denotes the smallest interpretation of the relation
$R$ which satisfies 
$$(\neg B)\wedge q)\vee (B\wedge \mbox{\it wp}(S, \exists y:R(y,\bar{z})  \wedge y<x ))$$
Such an interpretation exists because this latter formula
defines a monotonic function on the complete lattice of all
possible interpretations of $R$, which
extends any interpretation
of $R$ by evaluating this latter formula under  this interpretation,
so that we can apply
Knaster-Tarski Fixed Point Theorem.
Further, $\exists x:p(x)$ indeed
characterizes $\mbox{\it wp}(\WDD{B}{S},q)$
because 
we can associate
with each node of  a terminating computation tree with
a countable degree an ordinal
which is bigger than all the ordinals associated with its child nodes.
Note that the ordinals associated with the child nodes
form a \emph{set} and therefore there exists an upper-bound
(and the upper-bound of a countable set of countable ordinals is itself
a countable ordinal).

\NI
END

\section{Representing Proofs}

\subsection{Proof outlines}

Even though the LOOP rules for proving termination are equivalent in
the sense of Theorem \ref{thm:main}, they lead to different proofs of
total correctness of \textbf{while} programs.  This clearly holds for
the LOOP V rule which does not involve an explicit bound function but
uses the invariant for the specification of a bound.  But also the
other rules lead to different proofs.  The idea behind the LOOP III
rule is to establish that $p$ is a loop invariant and $t$ is a bound
function separately, while in the LOOP II rule both facts are
established simultaneously. So the LOOP III rule looks more convenient
when we want to strengthen a proof of partial correctness to a proof
of total correctness: it suffices to establish two new premises
concerned with the bound function $t$.  In turn, the LOOP IV rule
allows us to split the proof obligations even further, by identifying
the property actually needed to be proved in terms of total
correctness.  This, as already mentioned, allows one to support
modular reasoning.

However, matters change when we want to represent the proofs in the
resulting proof systems  in a convenient form. Given
that these proofs deal with structured programs, their most natural
representation consists of so-called \bfe{proof outlines}, a notion
introduced in \cite{OG76a}.  Informally, it is a proof representation
in the form of a program annotated by the assertions arising from the
appropriate rule applications. Such a representation is possible
thanks to the fact that the proof rules are syntax directed. Proof
outlines were introduced in \cite{OG76a} in order to reason about
correctness of parallel programs, where they served to establish
so-called interference freedom among the proofs of the component
programs. However, they are also very useful as a representation of
correctness proofs of sequential programs and, when some obvious
assertions are deleted, as a program documentation.

Now, given that the LOOP III and IV rules have more than one premise
consisting of a correctness formula, it is difficult to employ
a single proof outline to represent a proof involving any of these rules.
This is not the case with the LOOP II and LOOP V rules. To illustrate this point
recall first that the proof outlines are defined by induction on the program structure.
We only focus on the crucial formation rule concerned with the \textbf{while} statement.
For the proof system I the following formation rule was used in \cite{ABO09}:

\[
\frac{\raisebox{2mm}{$ \HT{p \A B}{S^*}{p}$}}
            {\raisebox{-2mm}{$\HT{{\bf inv:}\ p}
                 {\WDD{B}{\HT{p \A B}{S^*}{p}}}
                 {p \A \neg B}$}}
\]
where $S^*$ is the program $S$ annotated with some assertions.
\III

For the proof system II we introduce the following formation rule:
\III

\NI
\[
\begin{array}{l}
\HT{p \A B \A t=z}{S^{*}}{p \A t<z},                    \\
p \ra t \geq 0                                          \\
[-\medskipamount]
\hrulefill                                              \\
\C{{\bf inv:}\ p}
\HT{{\bf bd:}\ t}
   {\WDD{B}{\HT{p \A B \A t = z}{S^*}{p \A t<z}}}
   {p \A \neg B}
\end{array}
\]

\NI
where $S^*$ and $S^{**}$ are annotations of
the program $S$ with some assertions, 
$t$ is an integer expression and $z$ is an integer variable
not occurring in $p,t,B$ or $S^{*}$.\footnote{In \cite{ABO09}, in contrast to \cite{ABO90},
there is a typo and $S^{**}$ is mentioned here instead of $S^{*}$.}
\III


% Finally, for the proof system III we introduce the following formation rule:
% \III

% \NI
% \[
% \begin{array}{l}
% \HT{p \A B \A t=z}{S^{*}}{p \A t<z},                    \\
% p \ra t \geq 0                                          \\
% [-\medskipamount]
% \hrulefill                                              \\
% \C{{\bf inv:}\ p}
% \HT{{\bf bd:}\ t}
%    {\WDD{B}{\HT{p \A B \A t = z}{S^*}{p \A t<z}}}
%    {p \A \neg B}
% \end{array}
% \]
% %
% \NI
% where $t$ and $z$ are as above.
% \III

For a moment we defer the discussion of proof outlines for the proof
system~IV.  One can easily prove by induction that each proof outline
for the proof system~I corresponds to a proof in this proof
system. For example, if by the induction hypothesis the proof outline
$\HT{p \A B}{S^*}{p}$ corresponds to a proof of $\HT{p \A B}{S}{p}$ in
I, then the proof outline
\[
  \HT{{\bf inv:}\ p}{\WDD{B}{\HT{p \A B}{S^*}{p}}}{p \A \neg B}
\]
corresponds to a proof of $\HT{p}{\WDD{B}{S}}{p \A \neg B}$ in I,
which is obtained by applying to $\HT{p \A B}{S}{p}$ the LOOP I rule.

However, this property fails to hold for the proof outlines for the proof
system~III, because the second proof outline used in the premise of the
formation rule is dropped. As a consequence, the proof outline for the
\textbf{while} statement does not allow one to reconstruct the proof
of $\HT{p}{\WDD{B}{S}}{p \A \neg B}$ in the proof system III.


\subsection{Proofs using the LOOP II rule}

By contrast, each proof outline for the proof system~II involving the LOOP~II rule
does correspond to a proof in this proof system, because all assertions
used are retained. In other words, from each proof outline for the
proof system~II a proof in this system can be extracted.  

To illustrate this point consider the following program $S_N$ involving nested
loops, suggested to us by Tobias Nipkow (private communication):

\begin{tabbing}
\qquad\qquad
$S_N \equiv$ \= $\WD{i < n}$           \\
\> \qquad $j:=i; $                     \\
\> \qquad $\WD{0 < j}$                 \\
\> \qquad \qquad $j:=j-1$              \\
\> \qquad \OD ;                        \\
\> \qquad $i:=i+1$                     \\
\> \OD                                               
\end{tabbing}
\noindent
where $i, j, n$ are integer variables. 

\III

We would like to prove that it terminates
for all initial states. To this end, we prove the correctness formula
\HT{\T}{S_N}{\T} in the proof system II.
In Fig.~\ref{fig:po}, we show the proof in the form of a proof outline,
instantiating the corresponding formation rule for the \textbf{while} statement in proof system II
with the following loop invariants and bound functions for the outer and the inner loop, respectively:                                                  \\
\[
  \mbox{$p \equiv \T$ and $t \equiv  \mbox{\it max}(n-i,0)$,}
\]
\[
  \mbox{$p \equiv  n-i = z_1 \A z_1>0$ and $t \equiv \mbox{\it max}(j,0)$.}
\]
Note that in a proof outline adjacent assertions stand for implications
according to an application of the CONSEQUENCE rule.
For instance, the assertion in line~3 implies that of line~4.
Assignments are treated by backward substitution according to the ASSIGNMENT axiom.
For instance, the assignment $i:=i+1$ in line~18 is dealt with by 
substituting $i$ by $i+1$ in the assertion in line~19, yielding
the assertion in line~17.


\begin{figure}[ht]

\begin{tabbing}
\ 1\qquad\qquad
 \= \C{\textbf{inv} : \T } \C{\textbf{bd}: \mbox{\it max}(n-i,0)}    \\
\ 2 \> $\WD{i < n}$                                                  \\
\ 3 \> \qquad \C{\T \A i < n \A \mbox{\it max}(n-i,0) = z_1}         \\
\ 4 \> \qquad \C{n-i = z_1 \A z_1>0 }                                \\
\ 5 \> \qquad \ \ $j:=i; $                                           \\
\ 6 \> \qquad \C{n-i = z_1 \A z_1>0}                                 \\
\ 7 \> \qquad \C{\textbf{inv} : n-i = z_1 \A z_1>0} \C{\textbf{bd}: \mbox{\it max}(j,0)} \\
\ 8\> \qquad $\WD{0 < j}$                                            \\
\ 9\> \qquad \qquad \C{n-i = z_1 \A z_1>0 \A 0<j\A  \mbox{\it max}(j,0)= z_2}  \\
10\> \qquad \qquad \C{n-i = z_1 \A z_1>0 \A  j = z_2 \A z_2>0 }      \\
11\> \qquad \qquad \C{n-i = z_1 \A z_1>0 \A j-1 < z_2 \A z_2>0 }     \\
12\> \qquad \qquad \ \ $j:=j-1$                                      \\
13\> \qquad \qquad \C{n-i = z_1 \A z_1>0 \A j < z_2 \A z_2>0}        \\
14\> \qquad \qquad \C{n-i = z_1 \A z_1>0 \A \mbox{\it max}(j,0) < z_2 }        \\
15\> \qquad \OD ;                                                    \\
16\> \qquad \C{n-i = z_1 \A z_1>0 \A \neg (0 < j)}                   \\
17\> \qquad \C{n-(i+1) < z_1 \A z_1>0 }                              \\
18\> \qquad \ \ $i:=i+1$                                             \\
19\> \qquad \C{n-i < z_1 \A z_1>0}                                   \\
20\> \qquad \C{\T \A \mbox{\it max}(n-i,0) < z_1 }                   \\
21\> \OD                                                             \\
22\> \C{\T \A \neg (i < n)}                                          \\
23\> \C{\T}
\end{tabbing}

\caption{Proof outline for \HT{\T}{S_N}{\T} in the proof system II.
The line numbers have been added for reference only.}
\label{fig:po}

\end{figure}



\subsection{Proofs using the LOOP IV rule}

Let us now move on to a discussion of the proofs involving the LOOP IV
rule.  This rule, just like the LOOP III rule, uses more than one
correctness formula as a premise. As a result, it shares with the LOOP
III rule the problem that it is not clear how to faithfully represent
correctness proofs using a single proof outline.
Indeed, each of the first three premises calls for a separate proof
outline.

But it is not difficult to see that this would give rise to largely
overlapping proof outlines.  So, instead, we propose an alternative
approach in which we replace these overlapping proof outlines
referring to the proof system~IV by an interrelated \emph{set} of
proof outlines in the sense of \emph{partial correctness}, so
referring to the proof system~I.

For a given correctness formula $\HT{p}{S}{q}$ to be proved in the
proof system~IV this set is defined as follows.  First, we have a
proof outline $\HT{p}{S^*}{q}$ that employs the first formation rule
given above and thus represents a proof of partial correctness of
$\HT{p}{S}{q}$ in I.

Next, for each occurrence of a loop $\WDD{B}{S_0}$ in $S$, we have a
proof outline $\HT{p_0\wedge B \wedge t=z}{S^*_0}{t<z}$, which
represents a proof of partial correctness of
$\HT{p_0\wedge B \wedge t=z}{S_0}{t<z}$ in I. Here $p_0$ is the
invariant associated with the occurrence of the loop $\WDD{B}{S_0}$ in
the above proof outline $\HT{p}{S^*}{q}$ and $t$ is some bound
function $t$ such that $p_0\to t\geq 0$.  We omit the proof that
existence of such a set of proof outlines in the sense of partial
correctness ensures a proof of the corresponding correctness formula
in the proof system~IV.  Intuitively, the use of the above proof
outlines for \emph{each} loop occurrence in $S$ ensures by structural
induction the third premise of the LOOP~IV rule, so
$\HT{p \A B}{S}{\mathbf{true}}$ in the sense of total correctness.

We illustrate how such a set of proof outlines can be used to
establish the proof of the correctness formula \HT{\T}{S_N}{\T} 
for Nipkow's program $S_N$ in
the proof system~IV.  We skip the trivial proof outline
$\HT{\T}{S^*_N}{\T}$, which corresponds to a proof of partial
correctness of $\HT{\T}{S_N}{\T}$.  Let $S_0$ denote the body of the
outer loop of $S_N$.  Given the bound function
$\mbox{\it max}(n-i,0)$, Fig.~\ref{fig:po2} shows the proof outline
which corresponds to a proof of  partial correctness of
$$\HT{\T\A i < n \A \mbox{\it max}(n-i,0) = z}{S_0}{\mbox{\it max}(n-i,0) < z},$$
assuming that the trivial invariant $\T$ is associated with this loop
in the proof outline $\HT{\T}{S^*_N}{\T}$.  Note that
$\T\to \mbox{\it max}(n-i,0)\geq 0$.
 
 \begin{figure}[ht]
 \begin{tabbing}
 \qquad\qquad                                       
\= \C{\T\A i < n \A \mbox{\it max}(n-i,0) = z}  \\
\>  \C{n-i = z \A z>0 }                         \\
\>  \ \ $j:=i; $                                \\
\>  \C{n-i = z \A z>0}                          \\
\>  \C{\textbf{inv} : n-i = z \A z>0}           \\
\> \qquad $\WD{0 < j}$                          \\
\>  \qquad \C{n-i = z \A z>0 }                  \\
\>  \qquad \ \ $j:=j-1$                         \\
\> \qquad \C{n-i = z \A z>0}                    \\
\>  \OD ;                                       \\
\>  \C{n-i = z \A z>0 \A \neg (0 < j)}          \\
\>  \C{n-(i+1) < z \A z>0 }                     \\
\>  \ \ $i:=i+1$                                \\
\> \C{n-i < z \A z>0}                           \\
\> \C{\mbox{\it max}(n-i,0) < z }               \\
[\bigskipamount]
\end{tabbing}
\caption{Proof outline for $\HT{\T\A i < n \A \mbox{\it max}(n-i,0) = z}{S_0}{\mbox{\it max}(n-i,0) < z}$  in the proof system I.}
\label{fig:po2}

\end{figure}

Finally, the LOOP IV rule requires to prove termination of $S_0$.
This boils down to establish the termination of the inner loop.
% Next, we introduce for the inner loop the
To this end, we introduce
the bound function $\mbox{\it max}(j,0)$.
Note that $\T\to \mbox{\it max}(j,0)\geq 0$. 
Fig.~\ref{fig:po3} shows the proof outline
which corresponds to a proof of  partial correctness of
$$\HT{\T\A 0<j\A  \mbox{\it max}(j,0)= z}{j:=j-1}{\mbox{\it max}(j,0) < z}.$$

 \begin{figure}[htbp]
 \begin{tabbing}
 \qquad\qquad    
\=\C{\T\A 0<j\A  \mbox{\it max}(j,0)= z}       \\
%\>  \C{j = z \A z>0 }                         \\
\>  \C{j-1 < z \A z>0 }                        \\
\>  \ \ $j:=j-1$                               \\
\>  \C{j < z \A z>0}                           \\
\> \C{\mbox{\it max}(j,0) < z }                \\
\end{tabbing}
\caption{Proof outline for $\HT{\T\A 0<j\A  \mbox{\it max}(j,0)= z}{j:=j-1}{\mbox{\it max}(j,0) < z}$  in the proof system I.}
\label{fig:po3}

\end{figure}

\subsection{Proofs using the LOOP V rule}

To conclude let us discuss proof outlines in presence of the LOOP V
rule.  To obtain a proof outline for $\HT{\T}{S_N}{\T}$ in the
proof system V it suffices to modify the loop invariants in the proof
outline for the proof system II given in Figure \ref{fig:po} as in the
proof of Lemma \ref{lem:main}$(vi)$, so by using, respectively,
\[
  \mbox{$p(z) \equiv max(n - i, 0) = z$,}
\]
\[
  \mbox{$p(z) \equiv n - i = z_1 \land z_1 > 0 \land max(j, 0) = z$,}
\]
and to drop the references to the bound functions.


\section{Practical Applications}

Research on program verification has entered practice most visibly by
the use of assertions as annotations of programs and program
interfaces that remain to be implemented.  This can be seen in the
paradigm of \emph{design by contract} introduced by Bertrand Meyer for
his object-oriented programming language Eiffel~\cite{Mey97}: program
design starts with a specification in terms of assertions, the
contract, against which the program is to be checked either statically
by means of a proof or dynamically at runtime.

This paradigm has been adopted and extended to other programming
languages, in particular to Java.
The \emph{Java Modeling Language} (JML) enriches Java with facilities for 
writing assertions (pre- and postconditions as well as 
class invariants) but also with a concept of abstract state space 
(using so-called model variables)~\cite{JML05}\footnote{See also
  \texttt{https://www.cs.ucf.edu/$\sim$leavens/JML/index.shtml}}.
For assertions, JML uses Java’s Boolean expressions extended by
universal and existential quantifiers. 
% \begin{verbatim}\forall\end{verbatim} and \begin{verbatim}\exists\end{verbatim}.
They are directly written into the Java source code in the form of comments 
starting with the symbols \texttt{//@}
(so that the annotated source code may be processed by both an ordinary Java compiler 
and a specialized JML tool). 

JML is designed to deal with the specification of Java classes,
but here we focus on loops.
JML provides the designated keywords 
\texttt{requires} for specifying the precondition,
\texttt{ensures} for the postcondition,
\texttt{loop\_invariant}, and 
\texttt{loop\_decreases} for the bound function.
To enhance readability, the pre- and postcondition as well as the loop invariant may be split into several
assertions, each one stated after a separate repeated keyword\footnote{For an example, see 
       \texttt{https://www.openjml.org/examples/binary-search.html}}.
An annotated Java program corresponds to a proof outline as discussed here,
but restricted to the essential assertions for each loop (pre- and postcondition,
loop invariant and bound function).

Also for the programming language C, a standardized specification language for C programs, 
called ACSL and inspired by JML, has been designed, see for instance
\cite{BBBCKKMPPS21}\footnote{See also
       \texttt{https://frama-c.com/download/acsl-1.20.pdf}}.

% \texttt{*** For ACSL I found only web pages.}

\medskip

In this paper, we have shown that  the rules LOOP II-V 
for proving termination of loops are equivalent.
With respect to the number of premises LOOP~II and LOOP V are clearly
the simplest rules for proving termination.
However,  a proof using these rules in general require more
complex assertions because of the accumulation of the
specifications of the bound functions of  inner loops.
This can be seen in the proof outline given in Fig.~1, 
in which the assertions inside the inner loop refer to both $z_1$ and $z_2$,
where $z_1$ is the variable freezing the value of the bound function $max(n-i,0)$ of the outer loop
and $z_2$ is the variable freezing the value of the bound function $max(j,0)$ of the inner loop.
The reason is that in this proof outline we need to establish 
that the value of the bound function of the outer loop is not affected 
by the inner loop and that the value of the other bound function decreases.

The LOOP IV rule allows for a separate proof of termination of  each loop,  
which does not require the specification of  bound functions
for the  inner loops.
Thus we have a trade off between a single complex proof  and a number of simpler proofs,  where complexity is measured by
the size of the assertions.
What works best in practice depends on the particular program structure.




\bibliographystyle{abbrv}
\bibliography{term25}





\appendix

\section{Proof System I}
\label{sec:I}

The proof system I consists of the following axioms and rules:
\VV

\NI
AXIOM \label{rul:skip} SKIP
\[ \HT{p}{skip}{p} \]
%
\NI
AXIOM \label{rul:assi} ASSIGNMENT
\[ \HT{p[u:=t]}{u:=t}{p} \]
%
\NI
RULE \label{rul:comp} COMPOSITION
\[ \frac{ \HT{p}{S_1}{r}, \HT{r}{S_2}{q}                }
        { \HT{p}{S_1;\ S_2}{q}                          }\]
%
\NI
RULE \label{rul:cond} CONDITIONAL
\[ \frac{ \HT{p \A B}{S_1}{q}, \HT{p \A \neg B}{S_2}{q}         }
        { \HT{p}{\ITE{B}{S_1}{S_2}}{q}                          }\]
%
\NI
RULE \label{rul:loop} LOOP I
\[ \frac{ \HT{p \A B}{S}{p}                             }
        { \HT{p}{\WDD{B}{S}}{p \A \neg B}               }\]
%

\NI
RULE \label{rul:cons} CONSEQUENCE
\[ \frac{ p \ra p_1, \HT{p_1}{S}{q_1}, q_1 \ra q        }
        { \HT{p}{S}{q}                                  }\]
%
%\cb

Additionally, given an interpretation $\mathcal{I}$ for the underlying first-order language, 
we use as axioms all assertions that are true in $\mathcal{I}$. 
These assertions are used as premises in the CONSEQUENCE rule. 

\section{Weakest Precondition Calculus}\label{sec:WP}
The calculus consist of the following axioms:
\VV

\NI
AXIOM  SKIP
\[ \mbox{\it wp}(skip,p)\leftrightarrow p \]
%
\NI
AXIOM  ASSIGNMENT
\[  \mbox{\it wp}(u:=t,p)\leftrightarrow p[u:=t] \]
%
\NI
RULE COMPOSITION
\[ \mbox{\it wp}(S_1;S_2,q)\leftrightarrow 
         \mbox{\it wp}(S_1,\mbox{\it wp}(S_2,q))\]
%
\NI
RULE  CONDITIONAL
\[ \mbox{\it wp}(\ITE{B}{S_1}{S_2},q)\leftrightarrow
(\mbox{\it wp}(S_1,q)\wedge B)\vee 
(\mbox{\it wp}(S_2,q)\wedge \neg B)\]
%
\NI
RULE  LOOP 
\[ \mbox{\it wp}(\WDD{B}{S},q)\leftrightarrow
(q\wedge \neg B)\vee (\mbox{\it wp}(S, \mbox{\it wp}(\WDD{B}{S},q))\wedge B)
\]


% \section{Unrestricted Bound Functions} \label{LOOPIIt}


% % In \cite{ABO09}, to prove termination, we used the LOOP III rule
% % without the stipulation that $var(t) \subseteq var(B) \cup var(S)$.
% % %Call such a rule the LOOP II-$t$ rule.
% % We call the LOOP rules II-IV without this stipulation \emph{unrestricted}.
% % We now prove the following result.
% % % \bigskip


% % \NI
% % RULE \label{rul:loop2} LOOP II-$t$
% % \[
% % \begin{array}{l}
% % \HT{p \A B}{S}{p},                      \\
% % \HT{p \A B \A t=z}{S}{t<z},             \\
% % p \ra t \geq 0                         \\
% % [-\medskipamount]
% % \hrulefill                              \\
% % \HT{p}{\WDD{B}{S}}{p \A \neg\ B}
% % \end{array}
% % \]
% % %
% % \NI
% % where $t$ is an integer expression and $z$ is an integer variable
% % that does not appear in $p,B,t$ or $S$.
% % \III

% \textbf{Proof of Theorem \ref{thm:book}.}

% % \begin{theorem} \label{thm:book}
% % \mbox{} \\
% % The unrestricted  rules LOOP II, III, and IV, are  admissible in the proof system II, III, and IV, respectively.
% % \end{theorem}

% We begin by formulating a crucial lemma.
% Given a list of distinct variables $\bar{x}$ and a list of terms
% $\bar{t}$ of the same length, we denote by $[\bar{x} := \bar{t}]$ the
% \emph{simultaneous substitution} of each variable in $\bar{x}$ by the
% corresponding term in $\bar{t}$. The simultaneous substitution applied
% to a term $t$ or an assertion $p$, written as $t[\bar{x} := \bar{z}]$
% (respectively, $p[\bar{x} := \bar{z}]$), is defined in the usual way
% by properly taking care of the bound variables (see, e.g.,
% \cite[Subsection 2.7]{ABO09}).

% Below, given a list of distinct constants $\bar{c}$ and a list of
% terms $\bar{t}$ of the same length, we denote by
% $[\bar{c} := \bar{t}]$ the \emph{simultaneous replacement} of each
% constant in $\bar{c}$ by the corresponding term in $\bar{t}$, defined
% in the expected way.

% The following lemma formalizes the intuition that in the correctness
% proofs variables that are not used in the analyzed program play the
% same role as fresh constants. The first item concerns a simultaneous
% substitution, while the second one deals with a simultaneous
% replacement.

% \begin{lemma} \label{lem:z}

%   Let \it{PR} be one of the proof systems II, III or IV.  Suppose
%   that $\vdash_{PR} \HT{p}{S}{q}$.

% Assume that $\bar{x}$ and $\bar{c}$ are respectively a list of distinct variables and a list
% of distinct constants of the same length, none of which appears in $S$.
% Then
% \begin{enumerate}[(i)]
% \item $\vdash_{PR} \HT{p[\bar{x} := \bar{c}]}{S}{q[\bar{x} := \bar{c}]}$,

% \item $\vdash_{PR} \HT{p[\bar{c} := \bar{x}]}{S}{q[\bar{c} := \bar{x}]}$.
% \end{enumerate}

% \end{lemma}

% \begin{proof}
%   (Sketch)

% \NI
% The proof proceeds by induction on the structure of $S$ and is straightforward. We illustrate it by presenting
% just one case for $(ii)$, when
% $S \equiv \WDD{B}{S_0}$ and the proof system II. 
% %As in the proof of Theorem \ref{thm:1}$(i)$ [Theorem 2$(i)$ in our paper]
% Let 
% % \[
% %  \vdash_{\rm{II}} \HT{p_{0} \A B}{S_0}{p_{0}},
% % \]
% \[
%  \vdash_{\rm{II}} \HT{p_{0} \A B \A t = z}{S_0}{p_0\wedge  t < z},
% \]
% for some assertion $p_{0}$,  bound function $t$ and
% variable~$z$ such that
% the implications
% $p \ra p_{0}$, $p_{0} \ra t \ge 0$ and  $(p_{0} \A \neg B) \ra q$
% hold.

% Denote $p[\bar{c} := \bar{x}]$ by $p'$ and similarly with
% $p_{0}, B, q$ and $t$.  By the induction hypothesis the above 
% statement holds when we replace each assertion or term by its primed
% version and the primed versions of all three implications hold by
% logic.  Note that by the assumption about the constants in $\bar{c}$
% we have $B' \equiv B$.  Hence by the LOOP II rule
% \[
%   \vdash_{\rm II} \HT{p'_{0}}{\WDD{B}{S}}{p'_{0} \A \neg B},
% \]
% so by the CONSEQUENCE rule
% \[
%   \vdash_{\rm II} \HT{p'}{\WDD{B}{S}}{q'},
% \]
% as desired.
% \HB
% % The desired proof is obtained by performing, respectively, the simultaneous substitution
% % $[\bar{x} := \bar{c}]$ or the simultaneous replacement
% % $[\bar{c} := \bar{x}]$ on all assertions and integer expressions used
% % in the proof of $\HT{p}{S}{q}$ in \emph{PR}.
% \end{proof}

% Below we shall use this lemma twice, first to simultaneously
% substitute specific variables by (fresh) constants and then to
% replace these constants by the original variables.

% We can now establish Theorem \ref{thm:book}. We only treat the case of the unrestricted LOOP II rule that
% was needed to prove item $(iv)$ of Lemma \ref{lem:main}.

% Suppose
% % \[
% %   \vdash_{\rm{II}}  \HT{p \A B}{S}{p},
% % \]
% \[
%   \vdash_{\rm{II}}  \HT{p \A B \A t=z}{S}{p\wedge t<z},
% \]
% and that
% $p \ra t \geq 0$ holds,
% where $t$ is an integer expression such that
% $var(t) \not\subseteq var(B) \cup var(S)$ and $z$ is an integer variable
% that does not appear in $p,B,S, t$ or $q$.

% % \[
% %   \vdash_{\rm{II}}    \HT{p}{\WDD{B}{S}}{p \A \neg\ B},
% % \]
% % where the last step in the proof consists of an application of the
% % LOOP II rule.  We now show that this correctness formula can also be
% % proved in the proof system II when in the LOOP II rule we additionally
% % stipulate that $var(t) \subseteq var(B) \cup var(S)$.

% Let $\bar{x}$ be a list formed by the variables from $var(t)$ that are
% not elements of $var(B) \cup var(S)$ and let $\bar{c}$ be a list of
% distinct constants of the same length as $\bar{x}$, none of which
% appears in $p,B,t$ or $S$. Denote
% $p[\bar{x} := \bar{c}]$ by $p'$ and $t[\bar{x} := \bar{c}]$ by $t'$.

% Then we have by Lemma \ref{lem:z}$(i)$
% % \[
% %  \vdash_{\rm{II}} \HT{p' \A B}{S}{p'},
% % \]
% \[
%  \vdash_{\rm{II}}  \HT{p' \A B \A t'=z}{S}{p'\wedge t'<z},         
% \]
% and
% \[
%   p' \ra t' \geq 0.
% \]

% Note that $var(t') \subseteq var(B) \cup var(S)$. So by an application of the LOOP II rule
% we obtain
% \[
%  \vdash_{\rm{II}}    \HT{p'}{\WDD{B}{S}}{p' \A \neg\ B},
% \]
% from which we get by Lemma \ref{lem:z}$(ii)$
% \[
%  \vdash_{\rm{II}}    \HT{p}{\WDD{B}{S}}{p \A \neg\ B},
% \]
% since $p'[\bar{c} := \bar{x}] \equiv p$ and $B[\bar{c} := \bar{x}] \equiv B$.
% \HB
% \VV

% % Analogous results hold for the same relaxations of the LOOP III and
% % IV rules.
% % Let us explain now the relevance of Theorem \ref{thm:book}.

\section{Admissibility of the Auxiliary Rules}\label{sec:proof}

\textbf{Proof of Theorem \ref{thm:aux}.}

We establish only the following claims that are needed in the proof of Theorem
\ref{thm:main}.

%\begin{theorem} \label{thm:1}
% The auxiliary rules $\te$-{\rm INTRODUCTION}, {\rm CONJUNCTION},
% and {\rm HYBRID CONJUNCTION} are admissible in the following proof systems:

 \begin{enumerate} [$(i)$] 
    
   \item The $\te$-{\rm INTRODUCTION} rule is admissible in the proof system {\rm II}. 
        
   \item The $\te$-{\rm INTRODUCTION} rule is admissible in the proof system {\rm III}.
  
   \item The {\rm CONJUNCTION} rule is admissible in the proof system {\rm II}.

   \item The {\rm HYBRID CONJUNCTION} rule is admissible in the proof system {\rm III},
         that is, \\
         if $\vdash_{\rm{I}} \HT{p_1}{S}{q_1}$ and $\vdash_{\rm{III}} \HT{p_2}{S}{q_2}$, then
         $\vdash_{\rm{III}} \HT{p_1 \A p_2}{S}{q_1 \A q_2}$.

 \end{enumerate}

% \end{theorem}

To prove these claims we first establish two lemmas that provide additional
information about the proofs in the considered proof systems.

\begin{lemma} \label{lemma:1}
Let $\mathit{PR}$ be one of the proof systems I, II, III, IV, or V.
If $\mathit{PR} \vdash \varphi$, there exists a proof of $\varphi$ in $\mathit{PR}$ 
with exactly one final application of the CONSEQUENCE rule.
\end{lemma}

\begin{proof}
Since implication $\ra$ is reflexive, we can always add to a given proof in $\mathit{PR}$
one final application of the CONSEQUENCE rule.
Since implication is transitive, successive applications of the CONSEQUENCE rule in a proof in $\mathit{PR}$
can be condensed into one application.
\HB
\end{proof} 

\begin{lemma} \label{lem:useful}
Let $\mathit{PR}$ be one of the proof systems I, II, III, IV, or V.
  \begin{enumerate} [(i)] 
  \item  Suppose that  $\vdash_{PR} \HT{p}{S_1; \ S_2}{q}$.
    Then for some assertion $r$
    \[
 \vdash_{PR} \HT{p}{S_1}{r} \mbox{ and }
 \vdash_{PR} \HT{r}{S_2}{q}.
\]

\item Suppose that  $\vdash_{PR} \HT{p}{\ITE{B}{S_1}{S_2}}{q}$.
    Then 
    \[
 \vdash_{PR} \HT{p \A B}{S_1}{q} \mbox{ and }
 \vdash_{PR} \HT{p \A \neg B}{S_2}{q}.
\]
 \end{enumerate}    
\end{lemma}
\begin{proof}
  \mbox{} \\
  $(i)$ By Lemma~\ref{lemma:1}, the considered correctness formula was proved using
  the COMPOSITION rule followed by a single application of the CONSEQUENCE rule.
  So for some assertions $p_1, r, q_1$, we have
    \[
 \vdash_{PR} \HT{p_1}{S_1}{r} \mbox{ and }
 \vdash_{PR} \HT{r}{S_2}{q_1}
\]
and the implications $p \to p_1$ and $q_1 \to q$ hold.
We now get the claim by the CONSEQUENCE rule.
\III

\NI
$(ii)$ The argument is analogous as in $(ii)$. 
\HB
\end{proof}

We now turn to the proof of the mentioned claims of Theorem
\ref{thm:aux}, repeating each time the statement to be proved.

\begin{proof}
 \mbox{} \\
\noindent
$(i)$  The $\te$-{\rm INTRODUCTION} rule is admissible in the proof system {\rm II}.

We proceed by induction on the structure of $S$
and consider a proof of \HT{p}{S}{q} in the proof system \rm{II}, where 
the last two steps involve an axiom or a rule of the proof system \rm{II} for 
the top-level operator of the program $S$, 
followed by one final application of the CONSEQUENCE rule
according to Lemma~\ref{lemma:1}.
In all cases we assume that $x \not\in var(S) \cup \mathit{free}(q)$.

\III

\NI
$\bullet$ \emph{Case} $S \equiv u:=t$.
Thus suppose $\vdash_{\rm{II}} \HT{p}{S}{q}$.
Then for some assertion $q_1$,
\[
 \vdash_{\rm{II}} \HT{q_1[u:=t]}{S}{q_1}
\]
by the ASSIGNMENT axiom,
and the implications 
$p \ra q_1[u:=t]$ and $q_1 \ra q$ hold.
We assumed that $x \not\in var(S)$,
so $x \not \equiv u$. 
By the assignment axiom, also
\[
 \HT{(\te x:q_1)[u:=t]}{S}{\te x:q_1}.
\]
Note that the implications 
$\te x:p \ra \te x: (q_1[u:=t])$ and $\te x: q_1 \ra \te x: q$ hold.
Since $x \not \equiv u$ and $x \not\in \mathit{free}(q)$, 
also the implications 
\[
 \te x: (q_1[u:=t]) \ra (\te x:q_1)[u:=t] \ \mbox{ and }\  (\te x:q) \ra q
\] 
hold.
So the CONSEQUENCE rule yields
$\vdash_{\rm{II}}  \HT{\te x: p}{S}{q}$, as desired.

\III

\NI
$\bullet$ \emph{Case} $S \equiv S_1 ;\ S_2$.
Thus suppose $\vdash_{\rm{II}} \HT{p}{S}{q}$.
By Lemma \ref{lem:useful}$(i)$
for some assertion $r$, 
\[
 \vdash_{\rm{II}} \HT{p}{S_1}{r}  \mbox{ and }
 \vdash_{\rm{II}} \HT{r}{S_2}{q}.
\]
Since $r \ra \te x:r$, the CONSEQUENCE rule yields
$\vdash_{\rm{II}}  \HT{p}{S_1}{\te x: r}$.
Since $x \not \in \mathit{free}(\te x: r)$, the induction hypothesis yields
$\vdash_{\rm{II}}  \HT{\te x: p}{S_1}{\te x: r}$.
Since $x \not\in \mathit{free}(q)$, 
by the induction hypothesis, also $\vdash_{\rm{II}}  \HT{\te x: r}{S_2}{q}$.
Thus by the COMPOSITION  rule, 
$\vdash_{\rm{II}}  \HT{\te x: p}{S}{q}$, as desired.


\III

\NI
$\bullet$ \emph{Case} $S \equiv \ITE{B}{S_1}{S_2}$.
Thus suppose $\vdash_{\rm{II}} \HT{p}{S}{q}$.
Then by Lemma \ref{lem:useful}$(ii)$,
\[
 \vdash_{\rm{II}} \HT{p \A B}{S_1}{q} \mbox{ and }
 \vdash_{\rm{II}} \HT{p \A \neg B}{S_2}{q}.
\]
By the induction hypothesis,
\[
 \vdash_{\rm{II}} \HT{\te x: (p \A B)}{S_1}{q}  \mbox{ and }
 \vdash_{\rm{II}} \HT{\te x: (p \A \neg B)}{S_2}{q}.
\]
Since $x \not\in var(B)$, the CONSEQUENCE rule yields
\[
 \vdash_{\rm{II}} \HT{(\te x: p) \A B}{S_1}{q}  \mbox{ and }
 \vdash_{\rm{II}} \HT{(\te x: p) \A \neg B}{S_2}{q}.
\]
By the CONDITIONAL rule,
$\vdash_{\rm{II}} \HT{\te x: p}{S}{q}$,
as desired.

\III

\NI
$\bullet$ \emph{Case} $S \equiv \WDD{B}{S_0}$.
Thus suppose $\vdash_{\rm{II}} \HT{p}{S}{q}$.
By the assumption about $t$, we have
$x \not \in var(t)$ and without loss of generality we can assume $x \neq z$.
Then for some assertion $p_{0}$ and an appropriate bound function $t$ and
variable~$z$,
\[
 \vdash_{\rm{II}} \HT{p_{0} \A B \A t = z}{S_0}{p_0\wedge t < z},
\]
and the implications
$p \ra p_{0}$, $p_{0} \ra t \ge 0$,  $(p_{0} \A \neg B) \ra q$
hold.

Since $(p_0\wedge t<z) \ra ((\te x: p_0)\wedge t<z) $, the CONSEQUENCE rule yields
\[
 \vdash_{\rm{II}} \HT{p_{0} \A B \A t=z}{S_0}{(\te x: p_{0})\wedge t<z }.
\]
By the induction hypothesis, the assumption about $x$,
and the CONSEQUENCE rule 
\[
 \vdash_{\rm{II}} \HT{(\te x:p_0) \A B \A t = z}{S_0}{(\te x:p_0)\A t < z}.
\]
So the LOOP II rule yields 
\[
 \vdash_{\rm{II}} \HT{\te x:p_0}{S}{(\te x:p_0) \A \neg B}.
\]
Further, since $(p_{0} \A \neg B) \ra q$ holds and
$x \not\in (\mathit{free(q)} \cup var(B))$, also the implication
$((\te x:p_0) \A \neg B) \ra q$ holds.  So a final application of the
CONSEQUENCE rule yields $\vdash_{\rm{II}} \HT{\te x:p}{S}{q}$, as
desired.

\III

\noindent
$(ii)$ The $\te$-{\rm INTRODUCTION} rule is admissible in the proof system {\rm III}.

Again, we proceed by induction on the structure of $S$,
but now consider a proof of \HT{p}{S}{q} in the proof system \rm{III}, where 
the last two steps involve the axiom or rule of the proof system \rm{III} 
for the top-level operator of the program $S$, 
followed by one final application of the CONSEQUENCE rule
according to Lemma~\ref{lemma:1}.

Except for the \textbf{while} statement, all cases are analogous, 
with $\vdash_{\rm{II}}$ replaced by $\vdash_{\rm{III}}$. 
The case of the \textbf{while} statement differs from $(i)$ only 
in that one now considers two correctness formulas in the premise 
of the LOOP III rule instead of one. 
As above, let $S \equiv \WDD{B}{S_0}$ and
suppose $\vdash_{\rm{III}} \HT{p}{S}{q}$.
By the assumption about $t$, we have
$x \not \in var(t)$ and without loss of generality we can assume $x \neq z$.
Then for some assertion $p_{0}$ and an appropriate bound function $t$ and
variable~$z$,
\[
 \vdash_{\rm{III}} \HT{p_{0} \A B}{S_0}{p_{0}},
\]
\[
 \vdash_{\rm{III}} \HT{p_{0} \A B \A t = z}{S_0}{t < z},
\]
and the implications
$p \ra p_{0}$, $p_{0} \ra t \ge 0$,  $(p_{0} \A \neg B) \ra q$
hold.

Since $p_0 \ra \te x: p_0$, the CONSEQUENCE rule yields
\[
 \vdash_{\rm{III}} \HT{p_{0} \A B}{S_0}{\te x: p_{0}}.
\]
By the induction hypothesis, the assumption about $x$,
and the CONSEQUENCE rule both
\[
 \vdash_{\rm{III}} \HT{(\te x:p_0) \A B}{S_0}{\te x: p_{0}}
\]
and
\[
 \vdash_{\rm{III}} \HT{(\te x:p_0) \A B \A t = z}{S_0}{t < z}.
\]
So the LOOP III rule yields 
\[
 \vdash_{\rm{III}} \HT{\te x:p_0}{S}{(\te x:p_0) \A \neg B}.
\]
Further, since $(p_{0} \A \neg B) \ra q$ holds and
$x \not\in (\mathit{free(q)} \cup var(B))$, also the implication
$((\te x:p_0) \A \neg B) \ra q$ holds.  So a final application of the
CONSEQUENCE rule yields $\vdash_{\rm{III}} \HT{\te x:p}{S}{q}$, as
desired.

\III

\NI
$(iii)$ The {\rm CONJUNCTION} rule is admissible in the proof system {\rm II}.

We proceed by induction on the structure of $S$
and for $i=1,2$ consider proofs of \HT{p_i}{S}{q_i} in the proof system \rm{II}, where 
the last two steps involve the axiom or rule of the proof system \rm{II} 
for the top-level operator of the program $S$, 
followed by one final application of the CONSEQUENCE rule
according to Lemma~\ref{lemma:1}.

\III

\NI
$\bullet$ \emph{Case} $S \equiv u:=t$.
Thus suppose $\vdash_{\rm{II}} \HT{p_1}{S}{q_1}$ and
$\vdash_{\rm{II}} \HT{p_2}{S}{q_2}$.
Then for some assertions $q_{01}$ and $q_{02}$,
by the ASSIGNMENT axiom, both
\[
 \vdash_{\rm{II}} \HT{q_{01}[u:=t]}{S}{q_{01}} \ \mbox{ and }\
 \vdash_{\rm{II}} \HT{q_{02}[u:=t]}{S}{q_{02}},
\]
and the implications 
$p_1 \ra q_{01}[u:=t]$, $q_{01} \ra q_1$ and
$p_2 \ra q_{02}[u:=t]$, $q_{02} \ra q_2$ hold.
The ASSIGNMENT axiom also yields
\[
 \HT{q_{01}[u:=t] \A q_{02}[u:=t]}{S}{q_{01} \A q_{02}}.
\]
By the implications 
$(p_1 \A p_2) \ra (q_{01}[u:=t] \A q_{02}[u:=t])$ and 
$(q_{01} \A q_{02}) \ra$ $(q_1 \A q_2)$,
the CONSEQUENCE rule yields
\[
  \vdash_{\rm{II}} \HT{p_1 \A p_2}{S}{q_1 \A q_2},
\]
as desired.

\III

\NI
$\bullet$ \emph{Case} $S \equiv S_1 ;\ S_2$.
Thus suppose $\vdash_{\rm{II}} \HT{p_1}{S}{q_1}$ and
$\vdash_{\rm{II}} \HT{p_2}{S}{q_2}$.
Then by Lemma \ref{lem:useful}$(i)$ for some assertions $r_1$ and $r_2$
\[
 \vdash_{\rm{II}} \HT{p_{1}}{S_1}{r_1} \ \mbox{ and }\ 
 \vdash_{\rm{II}} \HT{r_1}{S_2}{q_{1}},
\]
\[
 \vdash_{\rm{II}} \HT{p_{2}}{S_1}{r_2} \ \mbox{ and }\
 \vdash_{\rm{II}} \HT{r_2}{S_2}{q_{2}}.
\]
By the induction hypothesis,
\[
 \vdash_{\rm{II}} \HT{p_1 \A p_2}{S_1}{r_1 \A r_2} \ \mbox{ and }\
 \vdash_{\rm{II}} \HT{r_1 \A r_2}{S_1}{q_1 \A q_2},
\]
so by the COMPOSITION rule,
\[
  \vdash_{\rm{II}} \HT{p_1 \A p_2}{S_1;\ S_2}{q_1 \A q_2},
\]
as desired.

\III

\NI
$\bullet$ \emph{Case} $S \equiv \ITE{B}{S_1}{S_2}$.
Thus suppose $\vdash_{\rm{II}} \HT{p_1}{S}{q_1}$ and
$\vdash_{\rm{II}} \HT{p_2}{S}{q_2}$.
Then by Lemma \ref{lem:useful}$(ii)$,
\[
 \vdash_{\rm{II}} \HT{p_{1}\A B}{S_1}{q_{1}} \ \mbox{ and }\
 \vdash_{\rm{II}} \HT{p_{1}\A \neg B}{S_2}{q_{1}},
\]
\[
 \vdash_{\rm{II}} \HT{p_{2} \A B}{S_1}{q_{2}} \ \mbox{ and }\
 \vdash_{\rm{II}} \HT{p_{2} \A \neg B}{S_2}{q_{2}}.
\]
By the induction hypothesis,
\[
 \vdash_{\rm{II}} \HT{p_{1}\A p_{2} \A B}{S_1}{q_{1} \A q_{2}}
\]
and
\[
 \vdash_{\rm{II}} \HT{p_{1}\A p_{2} \A \neg B}{S_2}{q_{1} \A q_{2}}.
\]
So by the CONDITIONAL rule,
\[
  \vdash_{\rm{II}} \HT{p_1 \A p_2}{\ITE{B}{S_1}{S_2}}{q_1 \A q_2},
\]
as desired.

\III

\NI
$\bullet$ \emph{Case} $S \equiv \WDD{B}{S_0}$.
Suppose $\vdash_{\rm{II}} \HT{p_1}{S}{q_1}$ and
$\vdash_{\rm{II}} \HT{p_2}{S}{q_2}$.
Then for some assertions $p_{01},p_{02}$, appropriate bound functions $t_1, t_2$ and
variables $z_1, z_2$,
\[
 \vdash_{\rm{II}} \HT{p_{01} \A B \A t_1 = z_1}{S_0}{p_{01} \A t_1 < z_1},
\]
\[
 \vdash_{\rm{II}} \HT{p_{02} \A B \A t_2 = z_2}{S_0}{p_{02} \A t_2 < z_2},
\]
the implications
$p_{01} \ra t_1 \ge 0, \, p_1 \ra p_{01}, \, (p_{01} \A \neg B) \ra q_1$
and
$p_{02} \ra t_2 \ge 0,$ $p_2 \ra p_{02}, \, (p_{02} \A \neg B) \ra q_2$
hold.

Without loss of generality we can assume that $z_2 \not \in \{z_1\} \cup \mathit{free}(p_{01})$.
By the induction hypothesis,
\[
 \vdash_{\rm{II}} \HT{p_{01} \A p_{02} \A B \A t_1 = z_1 \A t_2 = z_2}{S_0}
                     {p_{01} \A p_{02} \A t_1 < z_1 \A t_2 < z_2}.
\]

It suffices to consider one bound function, say $t_1$.
Formally, we show this as follows.
By the CONSEQUENCE rule,
\[
 \vdash_{\rm{II}} \HT{p_{01} \A p_{02} \A B \A t_1 = z_1 \A t_2 = z_2}{S_0}
                     {p_{01} \A p_{02} \A t_1 < z_1}.
\]
Now, an application of the $\te$-INTRODUCTION rule, which is admissible
in the proof system II according to part $(ii)$ of this theorem, followed by an application
of the CONSEQUENCE rule yields
\[
 \vdash_{\rm{II}} \HT{p_{01} \A p_{02} \A B \A t_1 = z_1 \A \te z_2: t_2 = z_2}{S_0}
                     {p_{01} \A p_{02} \A t_1 < z_1}.
\]
A further application of the CONSEQUENCE rule yields
\[
 \vdash_{\rm{II}} \HT{p_{01} \A p_{02} \A B \A t_1 = z_1}{S_0}
                     {p_{01} \A p_{02} \A t_1 < z_1}.
\]
Then by the LOOP II rule,
\[
  \vdash_{\rm{II}} \HT{p_{01} \A p_{02}}{\WDD{B}{S_0}}{p_{01} \A p_{02} \A \neg B}.
\]
The implications above yield
$(p_1 \A p_2) \ra (p_{01} \A p_{02})$ and
$(p_{01} \A p_{02} \A \neg B) \ra$ $(q_1 \A q_2)$.
Thus by the CONSEQUENCE rule,
\[
 \vdash_{\rm{II}} \HT{p_1 \A p_2}{\WDD{B}{S_0}}{q_1 \A q_2},
\]
as desired.
\III

\NI
$(iv)$ The {\rm HYBRID CONJUNCTION} rule is admissible in the proof system {\rm III},
that is,
if $\vdash_{\rm{I}} \HT{p_1}{S}{q_1}$ and $\vdash_{\rm{III}} \HT{p_2}{S}{q_2}$, then
$\vdash_{\rm{III}} \HT{p_1 \A p_2}{S}{q_1 \A q_2}$.

The proof is analogous to the proof of $(iii)$. 
The only case that is somewhat different is the one
concerned with the \textbf{while} statement. 
So we only deal with
\III

\NI
$\bullet$ \emph{Case} $S \equiv \WDD{B}{S_0}$.
Suppose $\vdash_{\rm{I}} \HT{p_1}{S}{q_1}$ and
$\vdash_{\rm{III}} \HT{p_2}{S}{q_2}$.
Then for some assertions $p_{01},p_{02}$ and an appropriate bound function $t$ and
variable~$z$,
\[
 \vdash_{\rm{I}} \HT{p_{01} \A B}{S_0}{p_{01}},
\]
\[
 \vdash_{\rm{III}} \HT{p_{02} \A B}{S_0}{p_{02}},
\]
\[
 \vdash_{\rm{III}} \HT{p_{02} \A B \A t = z}{S_0}{t < z},
\]
and the implications
\[
  p_1 \ra p_{01}, \, (p_{01} \A \neg B) \ra q_1, \,
  p_{02} \ra t \ge 0, \, p_2 \ra p_{02}, \, (p_{02} \A \neg B) \ra q_2
\]
hold. By the induction hypothesis,
\[
 \vdash_{\rm{III}} \HT{p_{01} \A p_{02} \A B}{S_0}
                     {p_{01} \A p_{02}},
\]
and by the induction hypothesis combined with the CONSEQUENCE rule,
\[
 \vdash_{\rm{III}} \HT{p_{01} \A p_{02} \A B \A t = z}{S_0}
                     {t < z}.
\]

So by the LOOP II rule,
\[
  \vdash_{\rm{III}} \HT{p_{01} \A p_{02}}{\WDD{B}{S_0}}{p_{01} \A p_{02} \A \neg B}.
\]
The implications above yield
$(p_1 \A p_2) \ra (p_{01} \A p_{02})$ and
$(p_{01} \A p_{02} \A \neg B) \ra$ $(q_1 \A q_2)$.
Thus by the CONSEQUENCE rule,
\[
 \vdash_{\rm{III}} \HT{p_1 \A p_2}{\WDD{B}{S_0}}{q_1 \A q_2},
\]
as desired.
\HB
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\end{document}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



